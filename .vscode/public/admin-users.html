<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DonorMedix · User Management</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
/* ===========================
   DonorMedix — Unified CSS (same layout as Admin Dashboard)
   - Sidebar fixed full-height on desktop
   - Sidebar becomes top nav on small screens
   =========================== */

* { margin: 0; padding: 0; box-sizing: border-box; }

:root{
  --brand: #3472a1;
  --brand-2: #0b90ab;
  --ink: #0f172a;
  --muted: #64748b;
  --line: #e2e8f0;
  --bg: #f8fafc;
  --card: #ffffff;
  --shadow: 0 8px 22px rgba(2,6,23,0.06);
  --radius: 14px;
  --danger: #ef4444;
  --warning: #f59e0b;
  --info: #3b82f6;
  --success: #22c55e;
  --sidebar-width: 230px;
  --topbar-height: 64px;
}

html,body { height: 100%; }

body {
  min-height: 100vh;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  background: radial-gradient(circle at top left, #ecfeff 0, #f8fafc 45%, #e2fbe8 100%);
  color: var(--ink);
  transition: background .15s ease, color .15s ease;
}
body.dark {
  background: #020617;
  color: #e5e7eb;
}

/* App layout */
.app { display: flex; min-height: 100vh; align-items: stretch; }

/* Sidebar fixed on desktop */
.sidebar {
  position: fixed;
  left: 0;
  top: 0;
  height: 100vh;
  width: var(--sidebar-width);
  min-width: var(--sidebar-width);
  max-width: var(--sidebar-width);
  background: linear-gradient(160deg, #020617, #0b1120, #1e293b);
  color: #e2e8f0;
  padding: 20px 18px;
  display: flex;
  flex-direction: column;
  gap: 20px;
  box-shadow: 8px 0 24px rgba(15,23,42,0.4);
  box-sizing: border-box;
  z-index: 1200;
  transition: transform .18s ease, width .12s ease;
  overflow: auto;
}

/* Main aware of sidebar on desktop */
.main {
  margin-left: var(--sidebar-width);
  flex: 1 1 auto;
  padding: 18px;
  min-height: 100vh;
  box-sizing: border-box;
}

.shell {
  max-width: 1120px;
  margin: 0 auto;
}

/* Sidebar branding */
.sidebar-brand { display:flex; align-items:center; gap:10px; margin-bottom:2px; }
.sidebar-mark {
  width:34px; height:34px; border-radius:999px;
  background: conic-gradient(from 140deg, var(--brand), var(--brand-2));
  display:flex; align-items:center; justify-content:center;
  font-weight:700; font-size:14px; color:#ecfdf5;
  box-shadow: 0 10px 25px rgba(37,99,235,0.15);
}
.sidebar-title { font-size:15px; font-weight:700; letter-spacing:.06em; text-transform:uppercase; }
.sidebar-sub { font-size:11px; color:#9ca3af; text-transform:uppercase; letter-spacing:.12em; }

/* Navigation links */
.nav { display:flex; flex-direction:column; gap:6px; }
.nav-link {
  display:flex; align-items:center; gap:8px;
  padding:8px 10px; border-radius:999px;
  text-decoration:none; font-size:13px;
  color:#e5e7eb; border:1px solid transparent;
  opacity:.95; cursor:pointer;
  transition: background .12s ease, border-color .12s ease, transform .06s ease, color .12s ease;
  -webkit-tap-highlight-color: transparent;
}
.nav-link span.icon {
  font-size:14px; width:18px; min-width:18px;
  text-align:center; display:inline-flex; justify-content:center; align-items:center;
}
.nav-link .icon i { display:inline-block; width:18px; text-align:center; color:currentColor; }

/* hover / focus */
.nav-link:hover,
.nav-link:focus,
.home-link:hover,
.home-link:focus {
  background: rgba(148,163,184,0.18) !important;
  border-color: rgba(148,163,184,0.5) !important;
  color: #ffffff !important;
  transform: translateY(0) !important;
  outline: none !important;
}

/* Active state */
.nav-link.active {
  background: linear-gradient(135deg, var(--brand), var(--brand-2)) !important;
  border-color: rgba(129,140,248,0.22) !important;
  color: #ecfdf5 !important;
  box-shadow: 0 10px 25px rgba(15,23,42,0.45) !important;
  opacity: 1 !important;
}

/* Footer / logout area */
.nav-footer { margin-top: auto; display:flex; flex-direction:column; gap:8px; }
.home-link {
  display:flex; align-items:center; gap:8px; padding:8px 10px;
  border-radius:999px; text-decoration:none; color:#94a3b8;
  font-size:13px; border:1px solid transparent; transition: background .12s;
}

/* small screens: sidebar becomes top bar */
@media (max-width: 880px) {
  .app {
    flex-direction: column;
  }

  .sidebar {
    position: relative;
    height: auto;
    width: 100%;
    min-width: auto;
    max-width: none;
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 10px 14px;
    box-shadow: none;
    overflow-x: auto;
  }

  .nav {
    flex-direction: row;
    flex-wrap: nowrap;
    gap: 8px;
  }

  .main {
    margin-left: 0;
    padding: 12px;
    min-height: calc(100vh - 64px);
  }

  .nav-footer {
    display:none;
  }
}

/* Cards */
.card {
  background: var(--card);
  border-radius: var(--radius);
  padding: 16px;
  box-shadow: var(--shadow);
  border: 1px solid rgba(2,6,23,0.04);
  margin-bottom: 18px;
}

/* Card header / title for this page */
.card-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
  margin-bottom:12px;
}
.card-title {
  font-size:15px;
  font-weight:600;
  color:var(--ink);
}
.card-subtitle {
  font-size:12px;
  color:var(--muted);
}
.card-tag {
  font-size:10px;
  padding:4px 9px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.55);
  text-transform:uppercase;
  letter-spacing:.14em;
  color:var(--muted);
  background:rgba(248,250,252,.7);
  white-space:nowrap;
}

/* Meta row */
.meta-row {
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:8px;
  font-size:11px;
  color:var(--muted);
  margin-top:6px;
  flex-wrap:wrap;
}

/* Table wrapper (for horizontal scroll on very small screens) */
.table-wrapper {
  width: 100%;
  overflow-x: auto;
  margin-top: 8px;
}

/* Table */
table {
  width:100%;
  border-collapse:collapse;
  background:var(--card);
  border-radius:12px;
  overflow:hidden;
  font-size:13px;
}
th, td {
  padding:10px;
  border-bottom:1px solid #e5e7eb;
  text-align:left;
  vertical-align:middle;
  word-break:break-word;
}
th {
  background:#eef7ff;
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.12em;
  color:var(--muted);
}
tr:last-child td {
  border-bottom:none;
}

/* status pill used in user list */
.status-pill {
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:3px 8px;
  border-radius:999px;
  font-size:11px;
}
.status-online {
  background:#dcfce7;
  color:#166534;
}
.status-offline {
  background:#f1f5f9;
  color:#64748b;
}
.dot {
  width:6px;
  height:6px;
  border-radius:999px;
}
.dot-green { background:#22c55e; }
.dot-gray { background:#9ca3af; }

/* Small buttons (delete) */
.btn-sm {
  border-radius:999px;
  border:none;
  padding:4px 10px;
  font-size:11px;
  font-weight:500;
  cursor:pointer;
}
.btn-danger {
  background:#ef4444;
  color:#fff;
}

/* Footer note */
.footer-note {
  margin-top: 18px;
  font-size: 11px;
  color: var(--muted);
  text-align: center;
}

/* responsiveness tweaks */
@media (max-width: 520px) {
  .sidebar {
    padding: 8px 10px;
  }
  .main {
    padding: 10px;
  }
  .card {
    padding: 12px;
  }
  .card-header {
    flex-direction:column;
    align-items:flex-start;
  }
}

/* dark mode tweaks */
body.dark .card { background: #020617; border-color: #1f2937; color: #e5e7eb; }
body.dark table { background: #020617; color:#e5e7eb; }
body.dark th { background: #0b1220; color:#e5e7eb; }
body.dark td { border-color: #1f2937; }

  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar" aria-label="Admin navigation">
      <div class="sidebar-brand">
        <div class="sidebar-mark">DM</div>
        <div>
          <div class="sidebar-title">DonorMedix</div>
          <div class="sidebar-sub">Admin Panel</div>
        </div>
      </div>

      <nav class="nav" role="navigation" aria-label="Main">
        <a href="admin-dashboard.html" class="nav-link">
          <span class="icon"><i class="fa-solid fa-gauge"></i></span> Dashboard
        </a>
        <a href="admin-users.html" class="nav-link active" aria-current="page">
          <span class="icon"><i class="fa-solid fa-users"></i></span> User Management
        </a>
        <a href="admin-requests.html" class="nav-link">
          <span class="icon"><i class="fa-solid fa-list-check"></i></span> Requests
        </a>
        <a href="admin-donations.html" class="nav-link">
          <span class="icon"><i class="fa-solid fa-hand-holding-heart"></i></span> Donations
        </a>
        <a href="admin-settings.html" class="nav-link">
          <span class="icon"><i class="fa-solid fa-gear"></i></span> Settings
        </a>
      </nav>

      <div class="nav-footer">
        <a href="home.html" class="nav-link home-link">
          <span class="icon"><i class="fa-solid fa-house"></i></span> Home
        </a>

        <!-- Logout button -->
        <a href="#" id="logoutBtn" class="nav-link" aria-label="Sign out">
          <span class="icon"><i class="fa-solid fa-right-from-bracket"></i></span> Logout
        </a>
      </div>
    </aside>

    <main class="main" role="main">
      <div class="shell">
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">User Management</div>
              <div class="card-subtitle">
                Manage registered donors, recipients, and admins.<br>
                <small>Includes <strong>Profession</strong> from user profile.</small>
              </div>
            </div>
            <span class="card-tag">Users</span>
          </div>

          <div class="meta-row">
            <div id="usersMeta">Loading users…</div>
            <div>Sorted by <strong>Newest</strong></div>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Role</th>
                  <th>Profession</th>
                  <th>Email</th>
                  <th>Status</th>
                  <th style="text-align:right;">Actions</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                <!-- filled by script -->
              </tbody>
            </table>
          </div>
        </section>

        <p class="footer-note">
          User Management page. Data is loaded from Firestore
          <code>users</code> docs (including <code>profession</code> from profile.js).
        </p>
      </div>
    </main>
  </div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      orderBy,
      onSnapshot,
      doc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
    import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAaWN2gj3VJxT6kwOvCX4LIXkWlbt0LTHQ",
      authDomain: "donormedix.firebaseapp.com",
      projectId: "donormedix",
      storageBucket: "donormedix.appspot.com",
      messagingSenderId: "627472172279",
      appId: "1:627472172279:web:9bf645b54d33075a0d7ff2",
      measurementId: "G-NTNPR4FPT7"
    };

    const tbody = document.getElementById("usersTableBody");
    const meta = document.getElementById("usersMeta");

    // simple escape helper
    function escapeHtml(s = "") {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;");
    }

    // render a user row
    function renderRow(id, data) {
      const name = data.name || data.displayName || "Unnamed user";
      const role = (data.role || "user").toLowerCase();
      const email = data.email || "";
      const profession = data.profession || "—";
      const isOnline = !!data.isOnline;

      const statusClass = isOnline ? "status-online" : "status-offline";
      const dotClass = isOnline ? "dot-green" : "dot-gray";
      const statusText = isOnline ? "Online" : "Offline";

      return `
        <tr data-uid="${escapeHtml(id)}">
          <td>${escapeHtml(name)}</td>
          <td style="text-transform:capitalize;">${escapeHtml(role)}</td>
          <td>${escapeHtml(profession)}</td>
          <td>${escapeHtml(email)}</td>
          <td>
            <span class="status-pill ${statusClass}">
              <span class="dot ${dotClass}"></span>
              ${statusText}
            </span>
          </td>
          <td style="text-align:right;">
            <button class="btn-sm btn-danger" data-action="delete" data-uid="${escapeHtml(id)}">
              <i class="fa-solid fa-trash"></i> Delete
            </button>
          </td>
        </tr>
      `;
    }

    (async function init() {
      let db = null;
      let requireAdmin = null;
      let auth = null;

      // try to use auth.js AppBridge if present
      try {
        const mod = await import('./auth.js');
        if (mod && mod.AppBridge) {
          const bridge = mod.AppBridge;
          if (bridge.db) db = bridge.db;
          if (bridge.requireAdmin) requireAdmin = bridge.requireAdmin;
          if (bridge.auth) auth = bridge.auth;
        }
      } catch (err) {
        console.info('auth.js AppBridge not available, falling back to client init.');
      }

      const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
      if (!db) db = getFirestore(app);
      if (!auth) {
        try { auth = getAuth(app); } catch (e) { console.warn('Failed to init auth:', e); }
      }

      // optional admin check if available
      try {
        if (typeof requireAdmin === 'function') {
          requireAdmin({ redirectTo: 'auth.html' });
        }
      } catch (err) {
        console.warn('requireAdmin call failed or unavailable:', err);
      }

      // Real-time users listener
      try {
        const qUsers = query(collection(db, 'users'), orderBy('createdAt', 'desc'));
        onSnapshot(qUsers,
          (snap) => {
            if (snap.empty) {
              tbody.innerHTML =
                '<tr><td colspan="6" style="text-align:center;color:#94a3b8;padding:14px;">No users found.</td></tr>';
              meta.textContent = '0 users';
              return;
            }

            let rows = '';
            snap.forEach((docSnap) => {
              rows += renderRow(docSnap.id, docSnap.data() || {});
            });
            tbody.innerHTML = rows;
            meta.textContent = `${snap.size} user${snap.size > 1 ? 's' : ''}`;
          },
          (err) => {
            console.error('users snapshot error:', err);
            meta.textContent = 'Failed to load users.';
            tbody.innerHTML =
              '<tr><td colspan="6" style="text-align:center;color:#ef4444;padding:14px;">Error loading users</td></tr>';
          }
        );
      } catch (err) {
        console.error('Failed to attach users snapshot:', err);
        meta.textContent = 'Error initializing users listener.';
      }

      // Deletion handler
      tbody.addEventListener('click', async (e) => {
        const btn = e.target.closest('[data-action="delete"]');
        if (!btn) return;
        const uid = btn.dataset.uid;
        if (!uid) return;

        if (!confirm('Delete this user document? (This will remove the Firestore user document but will NOT delete the Authentication user account.)')) return;

        try {
          await deleteDoc(doc(db, 'users', uid));
        } catch (err) {
          console.error('Delete user doc failed:', err);
          alert('Failed to delete user. Check Firestore rules and console.');
        }
      });

      // Logout button
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn && auth) {
        logoutBtn.addEventListener('click', async (ev) => {
          ev.preventDefault();
          try {
            await signOut(auth);
            window.location.href = 'home.html';
          } catch (err) {
            console.error('Sign out failed', err);
            alert('Sign out failed. See console for details.');
          }
        });
      }
    })();
  </script>
</body>
</html>
