<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DonorMedix ¬∑ Medicine Requests</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  :root{
    --brand:#0f766e; --brand-2:#0d9488; --muted:#6b7280; --line:#e5e7eb;
    --bg:#f8fafc; --card:#ffffff; --shadow:0 2px 10px rgba(0,0,0,0.05); --radius:14px;
  }
  body {
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
    line-height:1.5;color:#1f2937;
    background:linear-gradient(135deg,#d5dadf 0%,#7ac5c3 50%,#f8fafc 100%);
    min-height:100vh;position:relative;
  }
  header {
    position: sticky; top: 0; z-index: 20; background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(12px); border-bottom: 1px solid rgba(229,231,235,0.5);
  }
  .header-container {
    max-width: 70rem; margin: 0 auto; padding: 1rem 1.5rem;
    display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: .75rem;
  }
  .logo {
    font: 600 1.5rem cursive; background: linear-gradient(135deg,#0d9488,#14b8a6);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  }
  nav { display:flex; justify-content:center; gap:1rem; }
  nav a {
    position:relative; color:#4c4e4e; text-decoration:none; font-size:.9375rem;
    padding:.5rem 1rem; border-radius:8px; overflow:hidden; transition:color .3s; z-index:1;
  }
  nav a::before{content:""; position:absolute; inset:0; background:#0c8783; border-radius:8px;
    transform:scaleX(0); transform-origin:left; transition:.3s; z-index:-1}
  nav a:hover::before{transform:scaleX(1)} nav a:hover{color:#fff}
  nav a.active::before{transform:scaleX(1); background:#0f766e} nav a.active{color:#fff; font-weight:600}

  /* Buttons (Back = same size as Profile) */
  .header-actions{display:flex; gap:.5rem; align-items:center}
  .sign-in-btn,
  .btn-back{
    padding:.625rem 1rem; font:600 .9375rem system-ui,sans-serif; line-height:1;
    border-radius:10px; display:inline-flex; align-items:center; justify-content:center; cursor:pointer;
  }
  .sign-in-btn{background:#0d9488; color:#fff; border:1px solid #0d9488}
  .sign-in-btn:hover{background:#0f766e; transform:translateY(-2px)}
  .btn-back{background:#fff; color:#0f766e; border:1px solid #cfe8e6}
  .btn-back:hover{background:#e8fbf5}

  .container{max-width:1100px; margin:0 auto; padding:1rem 1.5rem 2rem; display:flex; flex-direction:column; align-items:center}
  .page-header{text-align:center; margin:.75rem 0 1rem}
  .page-header h1{font-size:2rem; color:#0f766e; font-weight:700}
  .page-header .sub{color:#000; font-size:1rem}

  .panel{
    width:100%; max-width:1200px; margin:0 auto; padding:1.25rem;
    background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
    display:flex; flex-direction:column; gap:1rem;
  }

  /* Tabs ‚Äî fixed size on hover (no jiggle) */
  .panel__tabs{display:flex; align-items:center; gap:.5rem; flex-wrap:wrap}
  .tab{
    display:inline-flex; align-items:center; gap:.5rem;
    padding:.6rem 1.1rem; border-radius:.75rem;
    border:2px solid transparent;
    background:#f0fdfa; color:#0f766e; font-weight:700; cursor:pointer;
    transition:background .15s ease, color .15s ease, border-color .15s ease;
    user-select:none;
  }
  .tab svg{width:18px; height:18px}
  .tab:hover{ background:#e6fffb; color:#0f766e; }
  .tab--active{ background:#0f766e; color:#fff; border-color:#0f766e; }
  .tab--ghost{margin-left:auto; background:transparent; color:#6b7280; border-color:transparent; cursor:default}

  .filters{display:flex; gap:1rem; flex-wrap:wrap}
  .results-meta{color:var(--muted); font-size:.95rem}
  .browse-list{display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:1.25rem; margin-top:.5rem}
  .browse-card{background:#fff; border-radius:1rem; box-shadow:0 2px 8px rgba(0,0,0,.05); overflow:hidden; display:flex; flex-direction:column; transition:transform .2s}
  .browse-card:hover{transform:translateY(-3px)}
  .browse-card-image img{width:100%; height:180px; object-fit:cover}
  .browse-card-content{padding:1rem; font-size:.95rem; color:#374151}
  .browse-card-content h3{color:#0f766e; font-size:1.1rem; margin-bottom:.4rem}
  .sign-in-btn.small{padding:.5rem .8rem; font-weight:700; border-radius:10px}

  /* Create form design */
  .form-grid{display:grid; grid-template-columns:1fr 1fr; gap:12px 16px}
  .form-card{background:#fff; border:1px solid var(--line); border-radius:12px; padding:14px; display:flex; gap:10px; align-items:flex-start}
  .fc-icon{width:28px; height:28px; border-radius:8px; display:grid; place-items:center; background:#ecfdf5; border:1px solid #cbeee3; color:#0d9488; flex:0 0 28px}
  .fc-body{flex:1}
  .fc-body label{font-weight:800; color:#0f172a; display:block; margin:2px 0 6px}
  .field{display:flex; align-items:center; gap:10px; border:1px solid var(--line); border-radius:12px; padding:10px 12px; background:#fff}
  .field:focus-within{border-color:#0ec6aa; box-shadow:0 0 0 3px rgba(16,185,129,.18)}
  .field input[type=text], .field textarea, .field select{border:none; outline:none; background:transparent; width:100%; font-size:.95rem; color:#111827}
  textarea{min-height:100px; resize:vertical}
  .loc-grid{display:grid; grid-template-columns:repeat(2,1fr); gap:10px}
  @media (max-width:720px){ .form-grid{grid-template-columns:1fr} .loc-grid{grid-template-columns:1fr} }
  .btn-primary{background:#0d9488; color:#fff; border:1px solid #0d9488; border-radius:12px; padding:.7rem 1.2rem; font-weight:800; cursor:pointer; transition:.2s}
  .btn-primary:hover{background:#0f766e; transform:translateY(-1px)}
  .muted{color:var(--muted); font-size:.9rem}
</style>
</head>
<body>
  <header>
    <div class="header-container">
      <div class="logo">DonorMedix</div>
      <nav class="nav">
        <a href="Home Page.html" class="nav-link">Home</a>
        <a href="browse.html" class="nav-link">Browse</a>
        <a href="Donate.html" class="nav-link">Donate</a>
        <a href="Request.html" class="active">Requests</a>
      </nav>
      <div class="header-actions">
        <button class="btn-back" id="backBtn" type="button">‚Üê Back</button>
        <button class="sign-in-btn" onclick="window.location.href='profile.html'">Profile</button>
      </div>
    </div>
  </header>

  <main class="container">
    <header class="page-header">
      <h1>Medicine Requests</h1>
      <p class="sub">Browse requests from community members or create your own</p>
    </header>

    <!-- Browse -->
    <section class="panel" id="browsePanel">
      <div class="panel__tabs" role="tablist">
        <button class="tab tab--active" data-tab="browse" role="tab" aria-selected="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><circle cx="11" cy="11" r="8"></circle><path d="M21 21l-4.3-4.3"></path></svg>
          Browse Requests
        </button>
        <button class="tab" data-tab="create" role="tab" aria-selected="false">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 5v14M5 12h14"></path></svg>
          Create Request
        </button>
        <span class="tab tab--ghost" aria-hidden="true">üí° Tips: verify expiry dates & packaging</span>
      </div>

      <div class="filters">
        <select id="categoryFilter">
          <option value="">All Categories</option>
          <option value="Pain Relief">Pain Relief</option>
          <option value="Antibiotic">Antibiotic</option>
          <option value="Cough">Cough</option>
          <option value="Other">Other</option>
        </select>

        <select id="urgencyFilter">
          <option value="">All Urgency</option>
          <option value="high">High</option>
          <option value="medium">Medium</option>
          <option value="low">Low</option>
        </select>
      </div>

      <div class="results-meta" id="count">Showing 0 requests</div>
      <div class="browse-list" id="requestsList"></div>
    </section>

    <!-- Create -->
    <section class="panel" id="createPanel" style="display:none">
      <h2 style="color:#0f766e">Create a New Request</h2>
      <form id="createForm" class="form-grid">
        <div class="form-card" style="grid-column:1/-1">
          <div class="fc-body">
            <label for="title">Medicine Name</label>
            <div class="field"><input type="text" id="title" placeholder="Enter medicine name" required></div>
          </div>
        </div>

        <div class="form-card" style="grid-column:1/-1">
          <div class="fc-body">
            <label for="description">Description</label>
            <div class="field" style="align-items:flex-start">
              <textarea id="description" placeholder="Include dosage, form, quantity, special notes‚Ä¶" required></textarea>
            </div>
            <div class="muted" style="margin-top:6px">Please don‚Äôt share private medical information.</div>
          </div>
        </div>

        <div class="form-card">
          <div class="fc-icon">üè∑Ô∏è</div>
          <div class="fc-body">
            <label for="category">Category</label>
            <div class="field">
              <select id="category" required>
                <option value="Pain Relief">Pain Relief</option>
                <option value="Antibiotic">Antibiotic</option>
                <option value="Cough">Cough</option>
                <option value="Other" selected>Other</option>
              </select>
            </div>
          </div>
        </div>

        <div class="form-card">
          <div class="fc-icon">‚è±Ô∏è</div>
          <div class="fc-body">
            <label for="urgency">Urgency</label>
            <div class="field">
              <select id="urgency" required>
                <option value="high">High</option>
                <option value="medium" selected>Medium</option>
                <option value="low">Low</option>
              </select>
            </div>
          </div>
        </div>

        <!-- PSGC Cascader -->
        <div class="form-card" style="grid-column:1/-1">
          <div class="fc-icon">üìç</div>
          <div class="fc-body">
            <label>Location</label>
            <div class="loc-grid">
              <div class="field"><select id="selRegion"><option value="">Select Region‚Ä¶</option></select></div>
              <div class="field"><select id="selProvince" disabled><option value="">Select Province‚Ä¶</option></select></div>
              <div class="field"><select id="selCityMun" disabled><option value="">Select City/Municipality‚Ä¶</option></select></div>
              <div class="field"><select id="selBarangay" disabled><option value="">Select Barangay‚Ä¶</option></select></div>
            </div>
            <div class="muted" style="margin-top:8px">Tip: If you skip the dropdowns, we‚Äôll use your saved profile location.</div>
            <div class="field" style="margin-top:10px">
              <input type="text" id="locationText" placeholder="Or type an address/landmark (optional)">
            </div>
          </div>
        </div>

        <div style="grid-column:1/-1; display:flex; gap:8px">
          <button type="submit" class="btn-primary">Submit Request</button>
          <button type="button" class="btn-back" id="backBtnBottom">‚Üê Back</button>
        </div>
      </form>
    </section>
  </main>

  <!-- App Script -->
  <script type="module">
    /* ========= Utilities ========= */
    var PSGC_BASE = "https://psgc.gitlab.io/api";
    function nowStr(){ var d=new Date(); return d.toLocaleDateString(undefined,{month:"short",day:"numeric",year:"numeric"}); }
    function timeAgo(ts){
      if(!ts) return "";
      var diff=(Date.now()-ts)/1000;
      if(diff<60) return String(Math.floor(diff))+"s ago";
      if(diff<3600) return String(Math.floor(diff/60))+"m ago";
      if(diff<86400) return String(Math.floor(diff/3600))+"h ago";
      return String(Math.floor(diff/86400))+"d ago";
    }
    function keyFor(uid,kind){ return "dmx_"+kind+"_"+uid; }
    function getArr(uid,kind){ try{ return JSON.parse(localStorage.getItem(keyFor(uid,kind))||"[]"); }catch(e){ return []; } }
    function setArr(uid,kind,arr){ localStorage.setItem(keyFor(uid,kind), JSON.stringify(arr)); }

    function fetchJson(url){
      return fetch(url).then(function(r){
        if(!r.ok) throw new Error("HTTP "+r.status+" for "+url);
        return r.json();
      });
    }
    function getRegions(){ return fetchJson(PSGC_BASE+"/regions/"); }
    function getProvincesByRegion(regionCode){
      return fetchJson(PSGC_BASE+"/regions/"+regionCode+"/provinces/")["catch"](function(){
        return fetchJson(PSGC_BASE+"/provinces/").then(function(all){ return all.filter(function(p){ return p.regionCode===regionCode; }); });
      });
    }
    function getCitiesMunsByProvince(provCode){
      return fetchJson(PSGC_BASE+"/provinces/"+provCode+"/cities-municipalities/")["catch"](function(){
        return fetchJson(PSGC_BASE+"/provinces/"+provCode+"/").then(function(prov){
          return fetchJson(PSGC_BASE+"/regions/"+prov.regionCode+"/cities-municipalities/").then(function(rc){
            return rc.filter(function(x){ return x.provinceCode===provCode; });
          });
        });
      });
    }
    function getBarangaysByCityMun(cm){
      var code=cm.code||cm.cityCode||cm.municipalityCode;
      return fetchJson(PSGC_BASE+"/cities/"+code+"/barangays/")["catch"](function(){
        return fetchJson(PSGC_BASE+"/municipalities/"+code+"/barangays/")["catch"](function(){
          return fetchJson(PSGC_BASE+"/barangays/").then(function(all){
            return all.filter(function(b){ return b.cityCode===code || b.municipalityCode===code; });
          });
        });
      });
    }
    function opt(text,value){ var o=document.createElement("option"); o.textContent=text; o.value=value; return o; }
    function locationFromSelects(selRegion, selProvince, selCityMun, selBarangay){
      var rn = selRegion && selRegion.selectedOptions[0] ? selRegion.selectedOptions[0].textContent : "";
      var pn = selProvince && selProvince.selectedOptions[0] ? selProvince.selectedOptions[0].textContent : "";
      var cn = selCityMun && selCityMun.selectedOptions[0] ? selCityMun.selectedOptions[0].textContent : "";
      var bn = selBarangay && selBarangay.selectedOptions[0] ? selBarangay.selectedOptions[0].textContent : "";
      var parts=[rn,pn,cn,bn].filter(function(x){return !!x;});
      return parts.join(" ¬∑ ");
    }

    /* ========= Firebase ========= */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

    var firebaseConfig = {
      apiKey: "AIzaSyAaWN2gj3VJxT6kwOvCX4LIXkWlbt0LTHQ",
      authDomain: "donormedix.firebaseapp.com",
      projectId: "donormedix",
      storageBucket: "donormedix.appspot.com",
      messagingSenderId: "627472172279",
      appId: "1:627472172279:web:9bf645b54d33075a0d7ff2",
      measurementId: "G-NTNPR4FPT7"
    };

    /* ========= Main Init ========= */
    window.addEventListener("DOMContentLoaded", function(){
      // Back buttons
      function goBack(){
        try{
          var ref=document.referrer||"";
          var sameOrigin = ref && new URL(ref, location.href).origin===location.origin;
          if (sameOrigin && history.length>1) { history.back(); }
          else { location.href="profile.html"; }
        }catch(e){ location.href="profile.html"; }
      }
      var backBtn = document.getElementById("backBtn");
      if (backBtn) backBtn.addEventListener("click", goBack);
      var backBtnBottom = document.getElementById("backBtnBottom");
      if (backBtnBottom) backBtnBottom.addEventListener("click", goBack);

      // Tabs
      var browsePanel = document.getElementById("browsePanel");
      var createPanel = document.getElementById("createPanel");
      var tabButtons = document.querySelectorAll(".panel__tabs > button.tab[data-tab]");
      Array.prototype.forEach.call(tabButtons, function(btn){
        btn.addEventListener("click", function(){
          Array.prototype.forEach.call(tabButtons, function(x){ x.classList.remove("tab--active"); });
          btn.classList.add("tab--active");
          var name = btn.getAttribute("data-tab");
          if (name==="browse"){ if(browsePanel) browsePanel.style.display=""; if(createPanel) createPanel.style.display="none"; }
          else { if(browsePanel) browsePanel.style.display="none"; if(createPanel) createPanel.style.display=""; }
        });
      });

      // PSGC selects
      var selRegion   = document.getElementById("selRegion");
      var selProvince = document.getElementById("selProvince");
      var selCityMun  = document.getElementById("selCityMun");
      var selBarangay = document.getElementById("selBarangay");
      var locationText= document.getElementById("locationText");

      var profileSavedLocation = (function(){
        try{ var c=JSON.parse(localStorage.getItem("userProfile")||"{}"); return c.location || ""; }catch(e){ return ""; }
      })();

      function initPSGC(savedText){
        if (!selRegion || !selProvince || !selCityMun || !selBarangay) return;
        selRegion.innerHTML="";   selRegion.appendChild(opt("Select Region‚Ä¶",""));
        selProvince.innerHTML=""; selProvince.appendChild(opt("Select Province‚Ä¶","")); selProvince.disabled=true;
        selCityMun.innerHTML="";  selCityMun.appendChild(opt("Select City/Municipality‚Ä¶","")); selCityMun.disabled=true;
        selBarangay.innerHTML=""; selBarangay.appendChild(opt("Select Barangay‚Ä¶","")); selBarangay.disabled=true;

        getRegions().then(function(regions){
          regions.sort(function(a,b){
            var an=a.regionName||a.name, bn=b.regionName||b.name;
            return an.localeCompare(bn);
          });
          regions.forEach(function(r){
            var name = r.regionName ? r.regionName : r.name;
            selRegion.appendChild(opt(name, r.code));
          });

          if (savedText){
            var parts = savedText.split(" ¬∑ ").map(function(s){ return (s||"").trim(); }).filter(function(s){ return !!s; });
            var r = parts[0], p = parts[1], c = parts[2], b = parts[3];
            if (r){
              var ro = Array.prototype.find.call(selRegion.options, function(o){ return o.textContent===r; });
              if (ro){ selRegion.value = ro.value; onRegionChange(false).then(function(){
                if (p){
                  var po = Array.prototype.find.call(selProvince.options, function(o){ return o.textContent===p; });
                  if (po){ selProvince.value = po.value; onProvinceChange(false).then(function(){
                    if (c){
                      var co = Array.prototype.find.call(selCityMun.options, function(o){ return o.textContent===c; });
                      if (co){ selCityMun.value = co.value; onCityMunChange(false).then(function(){
                        if (b){
                          var bo = Array.prototype.find.call(selBarangay.options, function(o){ return o.textContent===b; });
                          if (bo){ selBarangay.value = bo.value; }
                        }
                      }); }
                    }
                  }); }
                }
              }); }
            }
          }
        })["catch"](function(e){ console.warn("PSGC init failed:", e); });
      }

      function onRegionChange(clearLower){
        if (clearLower===undefined) clearLower=true;
        if (!selRegion || !selProvince || !selCityMun || !selBarangay) return Promise.resolve();
        var regionCode = selRegion.value;
        if (!regionCode){
          if (clearLower){
            selProvince.innerHTML=""; selProvince.appendChild(opt("Select Province‚Ä¶","")); selProvince.disabled=true;
            selCityMun.innerHTML="";  selCityMun.appendChild(opt("Select City/Municipality‚Ä¶","")); selCityMun.disabled=true;
            selBarangay.innerHTML=""; selBarangay.appendChild(opt("Select Barangay‚Ä¶","")); selBarangay.disabled=true;
          }
          return Promise.resolve();
        }
        selProvince.disabled=false;
        selProvince.innerHTML=""; selProvince.appendChild(opt("Loading provinces‚Ä¶",""));
        return getProvincesByRegion(regionCode).then(function(provs){
          selProvince.innerHTML=""; selProvince.appendChild(opt("Select Province‚Ä¶",""));
          provs.sort(function(a,b){ return a.name.localeCompare(b.name); }).forEach(function(p){ selProvince.appendChild(opt(p.name, p.code)); });
          selCityMun.innerHTML=""; selCityMun.appendChild(opt("Select City/Municipality‚Ä¶","")); selCityMun.disabled=true;
          selBarangay.innerHTML=""; selBarangay.appendChild(opt("Select Barangay‚Ä¶","")); selBarangay.disabled=true;
        })["catch"](function(e){ console.warn("Provinces load error:", e); });
      }

      function onProvinceChange(clearLower){
        if (clearLower===undefined) clearLower=true;
        if (!selProvince || !selCityMun || !selBarangay) return Promise.resolve();
        var code = selProvince.value;
        if (!code){
          if (clearLower){
            selCityMun.innerHTML=""; selCityMun.appendChild(opt("Select City/Municipality‚Ä¶","")); selCityMun.disabled=true;
            selBarangay.innerHTML=""; selBarangay.appendChild(opt("Select Barangay‚Ä¶","")); selBarangay.disabled=true;
          }
          return Promise.resolve();
        }
        selCityMun.disabled=false;
        selCityMun.innerHTML=""; selCityMun.appendChild(opt("Loading‚Ä¶",""));
        return getCitiesMunsByProvince(code).then(function(cms){
          selCityMun.innerHTML=""; selCityMun.appendChild(opt("Select City/Municipality‚Ä¶",""));
          cms.sort(function(a,b){ return a.name.localeCompare(b.name); }).forEach(function(c){ selCityMun.appendChild(opt(c.name, c.code)); });
          selBarangay.innerHTML=""; selBarangay.appendChild(opt("Select Barangay‚Ä¶","")); selBarangay.disabled=true;
        })["catch"](function(e){ console.warn("Cities load error:", e); });
      }

      function onCityMunChange(clearLower){
        if (clearLower===undefined) clearLower=true;
        if (!selCityMun || !selBarangay) return Promise.resolve();
        var code = selCityMun.value;
        if (!code){
          if (clearLower){
            selBarangay.innerHTML=""; selBarangay.appendChild(opt("Select Barangay‚Ä¶","")); selBarangay.disabled=true;
          }
          return Promise.resolve();
        }
        selBarangay.disabled=false;
        selBarangay.innerHTML=""; selBarangay.appendChild(opt("Loading barangays‚Ä¶",""));
        var cm = { code: code };
        return getBarangaysByCityMun(cm).then(function(brgys){
          selBarangay.innerHTML=""; selBarangay.appendChild(opt("Select Barangay‚Ä¶",""));
          brgys.sort(function(a,b){ return a.name.localeCompare(b.name); }).forEach(function(b){ selBarangay.appendChild(opt(b.name, b.code)); });
        })["catch"](function(e){ console.warn("Barangays load error:", e); });
      }

      if (selRegion) selRegion.addEventListener("change", function(){ onRegionChange(true); });
      if (selProvince) selProvince.addEventListener("change", function(){ onProvinceChange(true); });
      if (selCityMun) selCityMun.addEventListener("change", function(){ onCityMunChange(true); });
      initPSGC(profileSavedLocation);

      /* Firebase init */
      var app = initializeApp(firebaseConfig);
      var db  = getFirestore(app);
      var auth= getAuth(app);

      /* DOM for list & filters */
      var requestsList   = document.getElementById("requestsList");
      var countEl        = document.getElementById("count");
      var categoryFilter = document.getElementById("categoryFilter");
      var urgencyFilter  = document.getElementById("urgencyFilter");
      var createForm     = document.getElementById("createForm");

      function renderRequestCard(data, id){
        var card = document.createElement("div");
        card.className="browse-card";

        var imgWrap = document.createElement("div");
        imgWrap.className="browse-card-image";
        imgWrap.innerHTML = '<img src="https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?q=80&w=1200&auto=format&fit=crop" alt="Medicine">';

        var body = document.createElement("div");
        body.className="browse-card-content";

        var h = document.createElement("h3");
        h.textContent = data.title || "Request";
        body.appendChild(h);

        var p1 = document.createElement("p");
        p1.textContent = data.description || "";
        body.appendChild(p1);

        var p2 = document.createElement("p");
        p2.innerHTML = "Category: <strong>"+(data.category||"Other")+"</strong> ¬∑ Urgency: <strong>"+(data.urgency||"-")+"</strong>";
        body.appendChild(p2);

        var p3 = document.createElement("p");
        p3.textContent = "üìç " + (data.location || "‚Äî") + " ¬∑ ‚è± " + (data._when || "");
        body.appendChild(p3);

        var btn = document.createElement("button");
        btn.className="sign-in-btn small";
        btn.textContent = data.status === "matched" ? "Matched" : "Help";
        btn.disabled = data.status === "matched";
        btn.style.marginTop="8px";
        btn.addEventListener("click", function(){
          if (!auth.currentUser){ alert("Please sign in to help with a request."); return; }
          updateDoc(doc(db,"requests",id), { status:"matched", matchedBy:auth.currentUser.uid, matchedAt:serverTimestamp() })["catch"](function(e){
            console.error(e); alert("Failed to mark matched.");
          });
        });
        body.appendChild(btn);

        card.appendChild(imgWrap);
        card.appendChild(body);
        return card;
      }

      function renderList(docs){
        if (!requestsList || !countEl) return;
        var cat = categoryFilter ? categoryFilter.value : "";
        var urg = urgencyFilter ? urgencyFilter.value : "";
        requestsList.innerHTML="";
        var filtered = docs.filter(function(d){
          if (cat && d.data.category !== cat) return false;
          if (urg && d.data.urgency  !== urg) return false;
          return true;
        });
        countEl.textContent = "Showing " + filtered.length + " active request" + (filtered.length!==1?"s":"");
        filtered.forEach(function(item){ requestsList.appendChild(renderRequestCard(item.data, item.id)); });
      }

      var unsubscribe = null;
      function startListener(){
        if (!db || !requestsList || !countEl) return;
        if (unsubscribe) unsubscribe();
        var qy = query(collection(db,"requests"), orderBy("createdAt","desc"));
        unsubscribe = onSnapshot(qy, function(snapshot){
          var docs=[];
          snapshot.forEach(function(s){
            var d = s.data();
            var ms = d.createdAt && d.createdAt.toMillis ? d.createdAt.toMillis() : Date.now();
            d._when = timeAgo(ms);
            docs.push({ id:s.id, data:d });
          });
          renderList(docs);
        }, function(err){
          console.error("Listener error:", err);
          if (requestsList) requestsList.innerHTML = "<p>‚ö†Ô∏è Failed to load requests.</p>";
        });
      }
      startListener();
      if (categoryFilter) categoryFilter.addEventListener("change", startListener);
      if (urgencyFilter)  urgencyFilter.addEventListener("change", startListener);

      // Create form (bind once after auth resolves)
      var submitBound = false;
      onAuthStateChanged(auth, function(){
        if (!createForm || submitBound) return;
        submitBound = true;
        createForm.addEventListener("submit", function(e){
          e.preventDefault();
          if (!auth.currentUser){ alert("You must be signed in to create a request."); return; }

          var titleEl = document.getElementById("title");
          var descriptionEl = document.getElementById("description");
          var categoryEl = document.getElementById("category");
          var urgencyEl  = document.getElementById("urgency");

          var title = titleEl ? (titleEl.value||"").trim() : "";
          var description = descriptionEl ? (descriptionEl.value||"").trim() : "";
          var category = categoryEl ? categoryEl.value : "Other";
          var urgency  = urgencyEl ? urgencyEl.value : "medium";
          if (!title || !description){ alert("Please complete the form."); return; }

          // build location
          var casc = locationFromSelects(selRegion, selProvince, selCityMun, selBarangay);
          var finalLocation = casc || (locationText && locationText.value ? locationText.value.trim() : "");
          if (!finalLocation && profileSavedLocation) finalLocation = profileSavedLocation;

          addDoc(collection(db,"requests"), {
            title: title,
            description: description,
            category: category,
            urgency: urgency,
            location: finalLocation || null,
            requesterId: auth.currentUser.uid,
            requesterName: auth.currentUser.email || null,
            status: "open",
            createdAt: serverTimestamp()
          }).then(function(){
            // Bridge to Profile activity + counters via localStorage
            var arr = getArr(auth.currentUser.uid,"requests");
            arr.unshift({
              id:String(Date.now()), title:title,
              subtitle: description, date: nowStr(),
              status:"pending", statusClass:"status--reserved", emoji:"üìù"
            });
            setArr(auth.currentUser.uid,"requests",arr);

            var qKey = "dmx_activity_queue_"+auth.currentUser.uid;
            var q;
            try{ q = JSON.parse(localStorage.getItem(qKey)||"[]"); }catch(e){ q = []; }
            q.unshift({ text:"Request created", sub:title, kind:"post", ts:Date.now() });
            localStorage.setItem(qKey, JSON.stringify(q));

            // switch back to profile
            location.href = "profile.html#section-requests";
          })["catch"](function(err){
            console.error(err);
            alert("Failed to create request: " + (err.message || err));
          });
        });
      });
    });
  </script>
</body>
</html>
