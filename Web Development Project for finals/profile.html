<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DonorMedix ¬∑ Profile</title>
<style>
  :root{
    --bg:#f7f8fa; --card:#ffffff; --text:#0f172a; --muted:#6b7280; --line:#e6e8ee;
    --brand:#10b981; --brand-700:#059669; --accent:#f59e0b; --danger:#ef4444; --badge:#eaf7f3;
    --shadow:0 1px 2px rgba(16,24,40,.06), 0 8px 24px rgba(16,24,40,.06);
    --radius:14px;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
    line-height:1.5;color:#1f2937;
    background:linear-gradient(135deg,#d5dadf 0%,#7ac5c3 50%,#f8fafc 100%);
    min-height:100vh;position:relative;
  }

  header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,0.85);
    backdrop-filter:blur(12px);border-bottom:1px solid rgba(229,231,235,0.5)}
  .header-container{max-width:70rem;margin:0 auto;padding:1rem 1.5rem;display:grid;
    grid-template-columns:auto 1fr auto;align-items:center}
  .logo{font:600 1.5rem cursive;background:linear-gradient(135deg,#0d9488,#14b8a6);
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
  nav{display:flex;justify-content:center;gap:1rem}
  nav a{position:relative;color:#4c4e4e;text-decoration:none;font-size:.9375rem;
    padding:.5rem 1rem;border-radius:8px;overflow:hidden;transition:color .3s;z-index:1}
  nav a::before{content:"";position:absolute;inset:0;background:#0c8783;border-radius:8px;
    transform:scaleX(0);transform-origin:left;transition:transform .3s;z-index:-1}
  nav a:hover::before{transform:scaleX(1)}
  nav a:hover{color:#fff}
  nav a.active::before{transform:scaleX(1);background:#0f766e}
  nav a.active{color:#fff;font-weight:600}
  .sign-in-btn{background:#0d9488;color:#fff;padding:.625rem 1.5rem;font:500 .9375rem system-ui,sans-serif;border-radius:10px;cursor:pointer}
  .sign-in-btn:hover{background:#0f766e;transform:translateY(-2px)}
  .header-actions{display:flex;gap:.5rem}
  .btn-back{background:#fff;color:#0f766e;border:1px solid #cfe8e6;border-radius:10px;padding:.5rem .9rem;cursor:pointer}
  .btn-back:hover{background:#e8fbf5}

  .container{max-width:1080px;margin:24px auto;padding:0 16px}

  /* Profile header */
  .profile{
    background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
    box-shadow:var(--shadow);padding:18px;display:grid;grid-template-columns:auto 1fr auto;gap:16px;align-items:start
  }
  .profile-actions{display:flex;gap:8px;align-items:center}
  .chip-btn{
    display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;
    border:1px solid #0f766e1a;background:#0f766e;color:#fff;font-weight:700;cursor:pointer
  }
  .chip-btn.secondary{background:#0d9488}
  .hidden{display:none !important}

  .avatar{width:72px;height:72px;border-radius:999px;background:linear-gradient(135deg,#c0f1e5,#8fe0ce);
    display:grid;place-items:center;overflow:hidden;border:2px solid #d9efe9;cursor:pointer}
  .avatar img{width:100%;height:100%;object-fit:cover}
  .name{font-size:1.4rem;font-weight:800}
  .location{color:var(--muted);margin-top:2px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:8px}
  .badge{background:#eef2f7;border:1px solid #dde3ea;border-radius:999px;padding:4px 8px;font-weight:700;font-size:.78rem;color:#334155;display:inline-flex;align-items:center;gap:6px}
  .badge--verified{background:var(--badge);border-color:#c7efe3;color:#0f766e}
  .stars{display:inline-flex;gap:2px;vertical-align:middle}
  .stars svg{width:14px;height:14px;color:#fbbf24}
  .muted{color:#6b7280}
  .bio{margin:10px 0 14px;color:#334155}
  .metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;text-align:center;margin-top:8px}
  .metrics .n{color:#0f8a78;font-weight:800;font-size:1.4rem}
  .metrics .label{color:#6b7280;font-size:.9rem}
  @media (max-width:720px){
    .profile{grid-template-columns:1fr;align-items:stretch}
    .metrics{grid-template-columns:1fr 1fr}
    .profile-actions{justify-content:flex-start;margin-top:6px}
  }

  /* Tabs */
  .tabs{margin-top:16px;background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
  .tab-bar{display:flex;gap:4px;padding:10px 12px;border-bottom:1px solid var(--line);flex-wrap:wrap}
  .tab{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:1px solid transparent;font-weight:700;color:#0f172a;background:transparent;cursor:pointer}
  .tab--active{background:#f1fbf7;border-color:#cbeee3;color:#0d9488}
  .sections{display:grid;gap:16px;padding:14px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:16px}
  .card h3{margin:0 0 12px;font-size:1.05rem}
  .activity{display:grid;gap:12px}
  .act{display:grid;grid-template-columns:auto 1fr;gap:10px;align-items:start}
  .icon{width:32px;height:32px;border-radius:8px;display:grid;place-items:center;background:#f3f4f6;border:1px solid #e5e7eb}
  .icon.star{background:#fff7ed;border-color:#fde68a}
  .icon.post{background:#ecfeff;border-color:#c4f1f6}
  .icon.done{background:#ecfdf5;border-color:#bbf7d0}

  /* Lists */
  .toolbar{display:flex;justify-content:space-between;align-items:center;margin:6px 0 10px}
  .add-btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;border:1px solid #0f766e1a;background:#0f766e;color:#fff;font-weight:700;cursor:pointer}
  .add-btn svg{width:16px;height:16px}
  .donation-list,.request-list{display:grid;gap:12px}
  .donation-card,.request-card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center}
  .thumb{width:64px;height:64px;border-radius:12px;background:#f3f4f6;display:grid;place-items:center;border:1px solid #e5e7eb;overflow:hidden}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .item-title{font-weight:800}
  .item-sub{color:#6b7280}
  .item-date{color:#6b7280;font-size:.9rem;margin-top:4px}
  .status{border-radius:999px;padding:6px 10px;font-weight:700;font-size:.78rem;text-transform:lowercase;border:1px solid}
  .status--donated{background:#dcfce7;color:#166534;border-color:#bbf7d0}
  .status--available{background:#eef2ff;color:#3730a3;border-color:#dbe2ff}
  .status--reserved{background:#fef3c7;color:#92400e;border-color:#fde68a}

  .btn-del{border:1px solid #e5e7eb;background:#fff;color:#ef4444;border-radius:10px;padding:8px 10px;cursor:pointer}
  .btn-del:hover{background:#fff1f1}

  @media (max-width:720px){
    .donation-card,.request-card{grid-template-columns:1fr auto;grid-template-areas:"title status" "thumb status"}
    .donation-card .thumb,.request-card .thumb{grid-area:thumb}
  }

  /* floating back (mobile) */
  .fab-back{position:fixed;left:16px;bottom:16px;z-index:60;display:none;background:#fff;color:#0f766e;border:1px solid #cfe8e6;border-radius:10px;padding:.55rem .9rem}
  @media (max-width:960px){.fab-back{display:inline-flex}}

  /* Toggle base */
  .toggle{position:relative;width:44px;height:24px;border-radius:999px;background:#e5e7eb;cursor:pointer;flex-shrink:0;transition:.2s}
  .toggle::before{content:"";position:absolute;left:3px;top:3px;width:18px;height:18px;background:#fff;border-radius:50%;transition:.2s}
  .toggle.active{background:#10b981}
  .toggle.active::before{transform:translateX(20px)}

  /* Settings polish */
  #section-settings .settings-form{gap:28px}
  #section-settings fieldset{border:none;margin:0;padding:0}
  #section-settings legend{display:flex;align-items:center;gap:10px;font-weight:800;font-size:1.05rem;color:#0f172a;margin-bottom:14px}
  #section-settings legend .lg-icon{width:28px;height:28px;border-radius:10px;display:inline-grid;place-items:center;background:#ecfdf5;border:1px solid #cbeee3;color:#0d9488}
  #section-settings .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px 18px}
  @media (max-width:720px){#section-settings .grid-2{grid-template-columns:1fr}}
  #section-settings label{font-weight:700;color:#0f172a;margin:2px 0 6px}
  #section-settings .field{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;display:flex;align-items:center;gap:10px}
  #section-settings .field:focus-within{border-color:#0ec6aa; box-shadow:0 0 0 3px rgba(16,185,129,.18)}
  #section-settings .f-icon{width:18px;height:18px;color:#0d9488;opacity:.9;flex:0 0 18px}
  #section-settings input[type=text],
  #section-settings input[type=email],
  #section-settings textarea{border:none;outline:none;width:100%;background:transparent;font-size:.95rem;color:#111827}
  #section-settings textarea{min-height:100px}
  #section-settings .hint{color:#6b7280;font-size:.85rem;margin-top:6px}
  #section-settings .toggle-row{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:14px}
  #section-settings .toggle-row .tr-left{display:flex;align-items:center;gap:12px}
  #section-settings .toggle-row .tr-icon{width:28px;height:28px;border-radius:8px;display:grid;place-items:center;background:#f1fbf7;border:1px solid #cbeee3;color:#0d9488}
  #section-settings .toggle{box-shadow:inset 0 0 0 1px rgba(16,24,40,.06)}
  #section-settings .toggle.active{box-shadow:none}
  #section-settings .section-note{background:#f8fafc;border:1px dashed #e5e7eb;color:#475569;padding:10px 12px;border-radius:10px;font-size:.9rem}

  /* Location and profession selects */
  .loc-grid,.prof-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:720px){.loc-grid,.prof-grid{grid-template-columns:1fr}}
  .loc-grid select,.prof-grid select{width:100%;border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;font-size:.95rem;background:#fff}
  .loc-grid select:disabled{background:#f9fafb;color:#9ca3af}
</style>
</head>

<body>
  <header>
    <div class="header-container">
      <div class="logo">DonorMedix</div>
      <nav class="nav">
        <a href="Home Page.html" class="nav-link">Home</a>
        <a href="browse.html" class="nav-link">Browse</a>
        <a href="Donate.html" class="nav-link">Donate</a>
        <a href="Request.html" class="nav-link">Requests</a>
      </nav>
      <div class="header-actions">
        <button class="btn-back" id="backBtn" type="button">‚Üê Back</button>
        <button class="sign-in-btn" onclick="window.location.href='profile.html'">Profile</button>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="profile">
      <!-- Col 1 -->
      <div class="avatar" id="avatarClick" title="Click to change photo">
        <img id="profilePic" alt="Profile picture" src="default-profile.png"/>
      </div>

      <!-- Col 2 -->
      <div>
        <div class="name">Sarah Johnson</div>
        <!-- Profession under name -->
        <div class="location" id="professionLine">Add your profession</div>

        <div class="row">
          <span class="badge badge--verified">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l2.4 2 3-.3 1.3 2.7 2.7 1.3-.3 3 2 2.4-2 2.4.3 3-2.7 1.3-1.3 2.7-3-.3-2.4 2-2.4-2-3 .3-1.3-2.7-2.7-1.3.3-3L2 12l2-2.4-.3-3 2.7-1.3L8.7 3.7l3 .3L12 2z"/></svg>
            Verified
          </span>
          <span class="badge">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="#b45309"><path d="M12 2l3.1 6.3 7 1-5 4.9 1.2 7L12 18.8 5.7 21.2 6.9 14.2 2 9.3l7-1z"/></svg>
            Bronze Donor
          </span>

          <span class="stars" aria-label="4.8 out of 5 stars">
            <svg viewBox="0 0 24 24" fill="#fbbf24"><path d="M12 .8l3 6 6.6 1-4.8 4.6 1.2 6.6L12 16.9 6 19.1l1.2-6.6L2.4 7.8 9 6.8z"/></svg>
            <svg viewBox="0 0 24 24" fill="#fbbf24"><path d="M12 .8l3 6 6.6 1-4.8 4.6 1.2 6.6L12 16.9 6 19.1l1.2 6.6L2.4 7.8 9 6.8z"/></svg>
            <svg viewBox="0 0 24 24" fill="#fbbf24"><path d="M12 .8l3 6 6.6 1-4.8 4.6 1.2 6.6L12 16.9 6 19.1l1.2 6.6L2.4 7.8 9 6.8z"/></svg>
            <svg viewBox="0 0 24 24" fill="#fbbf24"><path d="M12 .8l3 6 6.6 1-4.8 4.6 1.2 6.6L12 16.9 6 19.1l1.2 6.6L2.4 7.8 9 6.8z"/></svg>
            <svg viewBox="0 0 24 24"><defs><linearGradient id="half" x1="0" x2="1"><stop offset="50%" stop-color="#fbbf24"/><stop offset="50%" stop-color="#e5e7eb"/></linearGradient></defs><path d="M12 .8l3 6 6.6 1-4.8 4.6 1.2 6.6L12 16.9 6 19.1l1.2 6.6L2.4 7.8 9 6.8z" fill="url(#half)"/></svg>
          </span>

          <!-- UPDATED: dynamic header summary -->
          <span class="muted">
            <span id="ratingDisplay">(4.8)</span>
            Member since <span id="sinceDisplay">2023</span>
            <span class="muted"> ¬∑ </span>
            <span id="donationsDisplay">12</span> donations
          </span>
        </div>

        <p class="bio">
          Healthcare professional passionate about helping others access essential medicines.
          I regularly donate unused medical supplies to support our community.
        </p>

        <div class="metrics" aria-label="User metrics">
          <div><div class="n" id="mDonations">12</div><div class="label">Total Donations</div></div>
          <div><div class="n" id="mRequests">3</div><div class="label">Total Requests</div></div>
          <div><div class="n" id="mRating">4.8</div><div class="label">Average Rating</div></div>
        </div>
      </div>

      <!-- Col 3: UPPER RIGHT actions -->
      <div class="profile-actions">
        <input id="uploadPic" type="file" accept="image/*" class="hidden" />
        <button id="editProfileBtn" class="chip-btn" type="button">‚úèÔ∏è Edit</button>
        <button id="saveProfileBtn" class="chip-btn secondary hidden" type="button">üíæ Save</button>
      </div>
    </section>

    <!-- Tabs -->
    <section class="tabs" style="margin-top:16px">
      <div class="tab-bar">
        <button class="tab tab--active" data-target="section-overview" aria-selected="true">Overview</button>
        <button class="tab" data-target="section-donations" aria-selected="false">My Donations</button>
        <button class="tab" data-target="section-requests" aria-selected="false">My Requests</button>
        <button class="tab" data-target="section-settings" aria-selected="false">Settings</button>
      </div>

      <div class="sections">
        <div class="card tab-panel" id="section-overview">
          <h3>Recent Activity</h3>
          <div class="activity" id="activityFeed"></div>
        </div>

        <!-- Donations -->
        <div class="card tab-panel" id="section-donations" style="display:none">
          <div class="toolbar">
            <h3 style="margin:0">My Donations</h3>
            <button class="add-btn" id="btnAddDonation" type="button">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
              Add Donation
            </button>
          </div>
          <div class="donation-list" id="donationsList"></div>
        </div>

        <!-- Requests -->
        <div class="card tab-panel" id="section-requests" style="display:none">
          <div class="toolbar">
            <h3 style="margin:0">My Requests</h3>
            <button class="add-btn" id="btnNewRequest" type="button">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
              New Request
            </button>
          </div>
          <div class="request-list" id="requestsList"></div>
        </div>

        <!-- Settings (Profile Info + Privacy + Location + Profession Categories) -->
        <div class="card tab-panel" id="section-settings" style="display:none">
          <form class="settings-form">
            <fieldset>
              <legend><span class="lg-icon">üë§</span> Profile Information</legend>
              <div class="grid-2">
                <div>
                  <label for="name">Full Name</label>
                  <div class="field">
                    <svg class="f-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5 0-8 2.5-8 5v1h16v-1c0-2.5-3-5-8-5Z"/></svg>
                    <input type="text" id="name" value="Sarah Johnson" disabled>
                  </div>
                </div>

                <!-- PROFESSION with categories -->
                <div style="grid-column:1/-1">
                  <label>Profession</label>
                  <div class="field" style="flex-direction:column;align-items:stretch;gap:10px">
                    <div class="prof-grid">
                      <select id="selProfCat" title="Category" disabled>
                        <option value="">Select Category‚Ä¶</option>
                      </select>
                      <select id="selProfRole" title="Role" disabled>
                        <option value="">Select Role‚Ä¶</option>
                      </select>
                    </div>
                    <!-- Custom fallback -->
                    <div class="field" id="profCustomWrap" style="display:none">
                      <svg class="f-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 4h16M4 10h16M4 16h10"/></svg>
                      <input type="text" id="profession" placeholder="Type your profession" disabled>
                    </div>
                  </div>
                  <div class="hint">Pick a category and role, or choose ‚ÄúOther (Custom)‚Äù to type your own.</div>
                </div>

                <div>
                  <label for="email">Email</label>
                  <div class="field">
                    <svg class="f-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 6h16v12H4z"/><path d="m22 6-10 7L2 6"/></svg>
                    <input type="email" id="email" value="sarah.johnson@email.com" disabled>
                  </div>
                </div>
                <div>
                  <label for="phone">Phone</label>
                  <div class="field">
                    <svg class="f-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.86 19.86 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.86 19.86 0 0 1 2.12 4.2 2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.12.89.3 1.76.54 2.6a2 2 0 0 1-.45 2L8.09 9.91a16 16 0 0 0 6 6l1.59-1.11a2 2 0 0 1 2-.15 12.29 12.29 0 0 0 2.6.54A2 2 0 0 1 22 16.92Z"/></svg>
                    <input type="text" id="phone" value="+1 (555) 123-4567" disabled>
                  </div>
                </div>

                <!-- LOCATION: Cascading selects -->
                <div style="grid-column:1/-1">
                  <label>Location</label>
                  <div class="field" style="flex-direction:column;align-items:stretch;gap:10px">
                    <div class="loc-grid">
                      <select id="selRegion" title="Region" disabled>
                        <option value="">Select Region‚Ä¶</option>
                      </select>
                      <select id="selProvince" title="Province" disabled>
                        <option value="">Select Province‚Ä¶</option>
                      </select>
                      <select id="selCityMun" title="City/Municipality" disabled>
                        <option value="">Select City/Municipality‚Ä¶</option>
                      </select>
                      <select id="selBarangay" title="Barangay" disabled>
                        <option value="">Select Barangay‚Ä¶</option>
                      </select>
                    </div>
                    <input type="text" id="location" class="hidden" value="">
                  </div>
                  <div class="hint">Pick Region ‚Üí Province ‚Üí City/Municipality ‚Üí Barangay. Saved on ‚ÄúSave‚Äù.</div>
                </div>

                <div style="grid-column:1/-1">
                  <label for="bio">Bio</label>
                  <div class="field">
                    <svg class="f-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 4h16M4 10h16M4 16h10"/></svg>
                    <textarea id="bio" disabled>Default</textarea>
                  </div>
                </div>
              </div>
            </fieldset>

            <fieldset>
              <legend> Privacy Settings</legend>
              <div class="toggle-row">
                <div class="tr-left">
                  <div>
                    <div style="font-weight:700">Show Location</div>
                    <small class="muted">Display your general location to other users</small>
                  </div>
                </div>
                <div class="toggle" id="toggleLocation" role="switch" aria-checked="false" tabindex="0"></div>
              </div>
              <div class="toggle-row" style="margin-top:10px">
                <div class="tr-left">
                  <div>
                    <div style="font-weight:700">Public Profile</div>
                    <small class="muted">Allow others to view your donation activity</small>
                  </div>
                </div>
                <div class="toggle" id="toggleProfile" role="switch" aria-checked="false" tabindex="0"></div>
              </div>
              <div class="section-note" style="margin-top:10px">
                You can change these anytime. Your email and phone aren‚Äôt shown publicly unless you start a chat with a recipient/donor.
              </div>
            </fieldset>
          </form>
        </div>
      </div>
    </section>
  </main>

  <button class="fab-back" id="backFab" type="button">‚Üê Back</button>

  <!-- Cloudinary Upload Widget -->
  <script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>

  <!-- JS (ESM) -->
  <script type="module">
    /* ---------- Back Buttons ---------- */
    const goBack = () => {
      try{
        const ref = document.referrer || "";
        const sameOrigin = ref && new URL(ref, location.href).origin === location.origin;
        if (sameOrigin && history.length > 1) history.back();
        else location.href = "Home Page.html";
      }catch(_){ location.href = "Home Page.html"; }
    };
    document.getElementById('backBtn')?.addEventListener('click', goBack);
    document.getElementById('backFab')?.addEventListener('click', goBack);

    /* ---------- Active Nav ---------- */
    const path = (location.pathname || '').split('/').pop().toLowerCase();
    document.querySelectorAll('.nav-link').forEach(a=>{
      const href = a.getAttribute('href')?.toLowerCase().trim();
      if(href && path && href === path){ a.classList.add('active'); }
    });

    /* ---------- Tabs ---------- */
    const tabs = document.querySelectorAll('.tab');
    const panels = document.querySelectorAll('.tab-panel');
    function showTab(id){
      panels.forEach(p => p.style.display = (p.id === id) ? 'block' : 'none');
      tabs.forEach(t => t.classList.toggle('tab--active', t.dataset.target === id));
      tabs.forEach(t => t.setAttribute('aria-selected', t.dataset.target === id ? 'true':'false'));
    }
    tabs.forEach(t => t.addEventListener('click', ()=> showTab(t.dataset.target)));
    showTab('section-overview');

    /* ---------- Helpers ---------- */
    const $ = (s)=>document.querySelector(s);
    const nowStr = ()=>{
      const d = new Date();
      return d.toLocaleDateString(undefined, {month:'short', day:'numeric', year:'numeric'});
    };
    const keyFor = (uid, kind)=>`dmx_${kind}_${uid}`;
    const getArr = (uid, kind)=>{ try{return JSON.parse(localStorage.getItem(keyFor(uid,kind))||'[]')}catch{return[]} };
    const setArr = (uid, kind, arr)=> localStorage.setItem(keyFor(uid,kind), JSON.stringify(arr));

    const donationsList = $('#donationsList');
    const requestsList  = $('#requestsList');
    const activityFeed  = $('#activityFeed');

    /* ---------- Cloudinary Upload (profile photo) ---------- */
    const CLOUDINARY_CLOUD_NAME = "dsw0erpjx";
    const CLOUDINARY_UNSIGNED_PRESET = "donormedix";

    function openCloudinaryWidget(onSuccess){
      if (!window.cloudinary || !window.cloudinary.createUploadWidget) {
        alert("Cloudinary widget failed to load. Check your network.");
        return;
      }
      const widget = window.cloudinary.createUploadWidget({
        cloudName: CLOUDINARY_CLOUD_NAME,
        uploadPreset: CLOUDINARY_UNSIGNED_PRESET,
        multiple: false,
        cropping: true,
        croppingAspectRatio: 1,
        sources: ["local","url","camera"],
        folder: "donormedix/avatars",
        maxImageFileSize: 5_000_000,
        clientAllowedFormats: ["jpg","jpeg","png","webp"],
        resourceType: "image"
      }, (error, result) => {
        if (error) {
          console.error("Cloudinary error:", error);
          const msg = (error.status === 400) ? "Check your upload preset (must be Unsigned) and cloud name." : "Upload failed.";
          alert(msg);
          return;
        }
        if (result && result.event === "success") {
          onSuccess(result.info.secure_url);
        }
      });
      widget.open();
    }

    document.getElementById('avatarClick')?.addEventListener('click', ()=>{
      const img = document.getElementById('profilePic');
      openCloudinaryWidget((url)=>{
        img.src = url;
        document.getElementById('saveProfileBtn')?.classList.remove('hidden');
        document.getElementById('editProfileBtn')?.classList.add('hidden');
        pushActivity('Profile photo updated', 'Preview shown ‚Äî click Save to persist', 'done');
      });
    });

    /* ---------- Activity helper ---------- */
    function pushActivity(text, sub, kind='post'){
      const color = kind==='done' ? '#10b981' : (kind==='star' ? '#f59e0b' : '#0ea5e9');
      const d = document.createElement('div');
      d.className = 'act';
      d.innerHTML = `
        <div class="icon ${kind}">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2">
            <path d="${kind==='done'?'M20 6L9 17l-5-5':'M12 5v14M5 12h14'}"/>
          </svg>
        </div>
        <div><div style="font-weight:700">${text}</div><div class="muted">${sub}</div></div>`;
      activityFeed?.prepend(d);
    }

    /* ---------- Firebase ---------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAaWN2gj3VJxT6kwOvCX4LIXkWlbt0LTHQ",
      authDomain: "donormedix.firebaseapp.com",
      projectId: "donormedix",
      storageBucket: "donormedix.appspot.com",
      messagingSenderId: "627472172279",
      appId: "1:627472172279:web:9bf645b54d33075a0d7ff2",
      measurementId: "G-NTNPR4FPT7",
    };
    const appFB = initializeApp(firebaseConfig);
    const db = getFirestore(appFB);
    const auth = getAuth(appFB);

    function updateMetricsUI(data){
      const n1 = document.getElementById("mDonations");
      const n2 = document.getElementById("mRequests");
      const n3 = document.getElementById("mRating");
      if (n1) n1.textContent = data.donations ?? 0;
      if (n2) n2.textContent = data.requests ?? 0;
      if (n3) n3.textContent = data.rating ?? 0;
    }

    function populateProfile(data){
      $("#profilePic")?.setAttribute("src", data.photoURL || "default-profile.png");
      document.querySelector(".name").textContent = data.name || "Anonymous User";
      document.getElementById("professionLine").textContent = data.profession || "Add your profession";
      ["name","email","phone","bio"].forEach(id=>{
        const el=document.getElementById(id); if(el) el.value = (data[id] ?? "");
      });
      const profInput = document.getElementById("profession");
      if (profInput && data.profession) profInput.value = data.profession;
      updateMetricsUI(data);
    }

    /* ---------- Donations & Requests (add + delete) ---------- */
    function setupAddButtons(uid, userData){
      const refDoc = doc(db, "users", uid);

      document.getElementById('btnAddDonation')?.addEventListener('click', async ()=>{
        const arr = getArr(uid,'donations');
        const item = { id: String(Date.now()), title:'New Donation', subtitle:'Auto-added draft', date:nowStr(), status:'available', statusClass:'status--available', emoji:'üéÅ' };
        arr.unshift(item); setArr(uid,'donations',arr); renderLists(uid);
        pushActivity('New donation posted', item.title, 'post');
        try{ await updateDoc(refDoc,{donations:increment(1)}); userData.donations=(userData.donations||0)+1; updateMetricsUI({ ...userData }); }catch(e){console.warn(e)}
        location.href = 'Donate.html';
      });

      document.getElementById('btnNewRequest')?.addEventListener('click', async ()=>{
        const arr = getArr(uid,'requests');
        const item = { id: String(Date.now()), title:'New Request', subtitle:'Urgency: medium', date:nowStr(), status:'pending', statusClass:'status--reserved', emoji:'üìù' };
        arr.unshift(item); setArr(uid,'requests',arr); renderLists(uid);
        pushActivity('Request created', item.title, 'post');
        try{ await updateDoc(refDoc,{requests:increment(1)}); userData.requests=(userData.requests||0)+1; updateMetricsUI({ ...userData }); }catch(e){console.warn(e)}
        location.href = 'Request.html';
      });
    }

    const donationItemTemplate = (d)=>`
      <article class="donation-card" data-id="${d.id}">
        <div class="thumb" aria-hidden="true">${d.emoji || 'üíä'}</div>
        <div>
          <div class="item-title">${d.title}</div>
          <div class="item-sub">${d.subtitle || ''}</div>
          <div class="item-date">Posted ${d.date || nowStr()}</div>
        </div>
        <div style="display:grid;gap:8px;justify-items:end">
          <span class="status ${d.statusClass || 'status--available'}">${d.status || 'available'}</span>
          <button class="btn-del" data-type="donation" data-id="${d.id}" type="button">Delete</button>
        </div>
      </article>`;

    const requestItemTemplate = (r)=>`
      <article class="request-card" data-id="${r.id}">
        <div class="thumb" aria-hidden="true">${r.emoji || 'üìù'}</div>
        <div>
          <div class="item-title">${r.title}</div>
          <div class="item-sub">${r.subtitle || ''}</div>
          <div class="item-date">Requested ${r.date || nowStr()}</div>
        </div>
        <div style="display:grid;gap:8px;justify-items:end">
          <span class="status ${r.statusClass || 'status--reserved'}">${r.status || 'pending'}</span>
          <button class="btn-del" data-type="request" data-id="${r.id}" type="button">Delete</button>
        </div>
      </article>`;

    function renderLists(uid){
      const ds = getArr(uid,'donations');
      const rs = getArr(uid,'requests');
      donationsList.innerHTML = ds.length ? ds.map(donationItemTemplate).join('') : '<div class="muted">No donations yet.</div>';
      requestsList.innerHTML  = rs.length ? rs.map(requestItemTemplate).join('') : '<div class="muted">No requests yet.</div>';
      const cached = JSON.parse(localStorage.getItem('userProfile')||'{}');
      updateMetricsUI({ donations: ds.length, requests: rs.length, rating: cached?.rating ?? 4.8 });
      updateHeaderSummary(uid, cached); /* <-- update the header summary line */
    }

    function setupDeleteHandlers(uid, userData){
      const refDoc = doc(db, "users", uid);

      const handleDelete = async (kind, id) =>{
        const key = kind === 'donation' ? 'donations' : 'requests';
        let arr = getArr(uid, key);
        const before = arr.length;
        arr = arr.filter(x => String(x.id) !== String(id));
        setArr(uid, key, arr);
        renderLists(uid);

        if (before !== arr.length) {
          try{
            await updateDoc(refDoc, { [key]: increment(-1) });
            userData[key] = Math.max(0, (userData[key] || 0) - 1);
            updateMetricsUI(userData);
            pushActivity(kind === 'donation' ? 'Donation removed' : 'Request removed', `ID ${id}`, 'done');
            updateHeaderSummary(uid, userData); /* keep header in sync */
          }catch(e){ console.warn(e); }
        }
      };

      donationsList?.addEventListener('click', (e)=>{
        const btn = e.target.closest('.btn-del');
        if (!btn) return;
        handleDelete('donation', btn.dataset.id);
      });

      requestsList?.addEventListener('click', (e)=>{
        const btn = e.target.closest('.btn-del');
        if (!btn) return;
        handleDelete('request', btn.dataset.id);
      });
    }

    /* ---------- Privacy toggles ---------- */
    function setupToggles(uid){
      const toggles = [
        { id:"toggleLocation", field:"showLocation" },
        { id:"toggleProfile", field:"publicProfile" },
      ];
      toggles.forEach(({id, field})=>{
        const el = document.getElementById(id);
        if(!el) return;
        const flip = async ()=>{
          const on = !el.classList.contains('active');
          el.classList.toggle('active', on);
          el.setAttribute('aria-checked', on ? 'true' : 'false');
          try{ await setDoc(doc(db,'users',uid), { [field]: on }, { merge:true }); }catch{}
        };
        el.addEventListener('click', flip);
        el.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){e.preventDefault();flip();}});
      });
    }
    function applyToggleState(id, on){
      const el = document.getElementById(id); if(!el) return;
      el.classList.toggle('active', !!on);
      el.setAttribute('aria-checked', !!on ? 'true' : 'false');
    }

    /* ---------- PSGC LOCATION CASCADER ---------- */
    const PSGC_BASE = "https://psgc.gitlab.io/api";

    async function fetchJson(url){
      const r = await fetch(url);
      if (!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
      return r.json();
    }
    async function getRegions(){ return fetchJson(`${PSGC_BASE}/regions/`); }
    async function getProvincesByRegion(regionCode){
      try{
        return await fetchJson(`${PSGC_BASE}/regions/${regionCode}/provinces/`);
      }catch{
        const all = await fetchJson(`${PSGC_BASE}/provinces/`);
        return all.filter(p=>p.regionCode===regionCode);
      }
    }
    async function getCitiesMunsByProvince(provCode){
      try{
        return await fetchJson(`${PSGC_BASE}/provinces/${provCode}/cities-municipalities/`);
      }catch{
        const prov = await fetchJson(`${PSGC_BASE}/provinces/${provCode}/`);
        const regionCities = await fetchJson(`${PSGC_BASE}/regions/${prov.regionCode}/cities-municipalities/`);
        return regionCities.filter(x=>x.provinceCode===provCode);
      }
    }
    async function getBarangaysByCityMun(cm){
      const code = cm.code || cm.cityCode || cm.municipalityCode;
      try{
        return await fetchJson(`${PSGC_BASE}/cities/${code}/barangays/`);
      }catch{
        try{
          return await fetchJson(`${PSGC_BASE}/municipalities/${code}/barangays/`);
        }catch{
          const all = await fetchJson(`${PSGC_BASE}/barangays/`);
          return all.filter(b=>b.cityCode===code || b.municipalityCode===code);
        }
      }
    }

    const selRegion = document.getElementById('selRegion');
    const selProvince = document.getElementById('selProvince');
    const selCityMun = document.getElementById('selCityMun');
    const selBarangay = document.getElementById('selBarangay');
    const hiddenLocation = document.getElementById('location');

    function opt(text, value){ const o=document.createElement('option'); o.textContent=text; o.value=value; return o; }

    function updateLocationString(){
      const rn = selRegion.selectedOptions[0]?.textContent || '';
      const pn = selProvince.selectedOptions[0]?.textContent || '';
      const cn = selCityMun.selectedOptions[0]?.textContent || '';
      const bn = selBarangay.selectedOptions[0]?.textContent || '';
      const parts = [rn, pn, cn, bn].filter(Boolean);
      hiddenLocation.value = parts.join(' ¬∑ ');
    }

    async function initPSGCCascader(savedText){
      selRegion.innerHTML = '';
      selRegion.append(opt('Select Region‚Ä¶',''));
      selProvince.innerHTML = ''; selProvince.append(opt('Select Province‚Ä¶','')); selProvince.disabled = true;
      selCityMun.innerHTML = ''; selCityMun.append(opt('Select City/Municipality‚Ä¶','')); selCityMun.disabled = true;
      selBarangay.innerHTML = ''; selBarangay.append(opt('Select Barangay‚Ä¶','')); selBarangay.disabled = true;

      const regions = await getRegions();
      regions.sort((a,b)=> (a.regionName||a.name).localeCompare(b.regionName||b.name));
      regions.forEach(r=>{
        const name = r.regionName ? `${r.regionName}` : r.name;
        selRegion.append(opt(name, r.code));
      });

      if (savedText){
        const [savedRegion, savedProv, savedCity, savedBrgy] = savedText.split(' ¬∑ ').map(s=>s?.trim()).filter(Boolean);
        if (savedRegion){
          const rOpt = Array.from(selRegion.options).find(o=>o.textContent===savedRegion);
          if (rOpt){ selRegion.value = rOpt.value; await onRegionChange(false); }
        }
        if (savedProv){
          const pOpt = Array.from(selProvince.options).find(o=>o.textContent===savedProv);
          if (pOpt){ selProvince.value = pOpt.value; await onProvinceChange(false); }
        }
        if (savedCity){
          const cOpt = Array.from(selCityMun.options).find(o=>o.textContent===savedCity);
          if (cOpt){ selCityMun.value = cOpt.value; await onCityMunChange(false); }
        }
        if (savedBrgy){
          const bOpt = Array.from(selBarangay.options).find(o=>o.textContent===savedBrgy);
          if (bOpt){ selBarangay.value = bOpt.value; }
        }
        updateLocationString();
      }
    }

    async function onRegionChange(clearLower=true){
      const regionCode = selRegion.value;
      if (!regionCode){
        if (clearLower){
          selProvince.innerHTML = ''; selProvince.append(opt('Select Province‚Ä¶','')); selProvince.disabled = true;
          selCityMun.innerHTML = ''; selCityMun.append(opt('Select City/Municipality‚Ä¶','')); selCityMun.disabled = true;
          selBarangay.innerHTML=''; selBarangay.append(opt('Select Barangay‚Ä¶','')); selBarangay.disabled = true;
        }
        updateLocationString();
        return;
      }
      selProvince.disabled = false;
      selProvince.innerHTML = ''; selProvince.append(opt('Loading provinces‚Ä¶',''));
      const provs = await getProvincesByRegion(regionCode);
      selProvince.innerHTML = ''; selProvince.append(opt('Select Province‚Ä¶',''));
      provs.sort((a,b)=> a.name.localeCompare(b.name)).forEach(p=> selProvince.append(opt(p.name, p.code)));
      selCityMun.innerHTML=''; selCityMun.append(opt('Select City/Municipality‚Ä¶','')); selCityMun.disabled = true;
      selBarangay.innerHTML=''; selBarangay.append(opt('Select Barangay‚Ä¶','')); selBarangay.disabled = true;
      updateLocationString();
    }

    async function onProvinceChange(clearLower=true){
      const code = selProvince.value;
      if (!code){
        if (clearLower){
          selCityMun.innerHTML=''; selCityMun.append(opt('Select City/Municipality‚Ä¶','')); selCityMun.disabled = true;
          selBarangay.innerHTML=''; selBarangay.append(opt('Select Barangay‚Ä¶','')); selBarangay.disabled = true;
        }
        updateLocationString();
        return;
      }
      selCityMun.disabled = false;
      selCityMun.innerHTML=''; selCityMun.append(opt('Loading‚Ä¶',''));
      const cms = await getCitiesMunsByProvince(code);
      selCityMun.innerHTML=''; selCityMun.append(opt('Select City/Municipality‚Ä¶',''));
      cms.sort((a,b)=> a.name.localeCompare(b.name)).forEach(c=> selCityMun.append(opt(c.name, c.code)));
      selBarangay.innerHTML=''; selBarangay.append(opt('Select Barangay‚Ä¶','')); selBarangay.disabled = true;
      updateLocationString();
    }

    async function onCityMunChange(clearLower=true){
      const code = selCityMun.value;
      if (!code){
        if (clearLower){
          selBarangay.innerHTML=''; selBarangay.append(opt('Select Barangay‚Ä¶','')); selBarangay.disabled = true;
        }
        updateLocationString();
        return;
      }
      selBarangay.disabled = false;
      selBarangay.innerHTML=''; selBarangay.append(opt('Loading barangays‚Ä¶',''));
      const cm = { code };
      const brgys = await getBarangaysByCityMun(cm);
      selBarangay.innerHTML=''; selBarangay.append(opt('Select Barangay‚Ä¶',''));
      brgys.sort((a,b)=> a.name.localeCompare(b.name)).forEach(b=> selBarangay.append(opt(b.name, b.code)));
      updateLocationString();
    }

    selRegion.addEventListener('change', ()=>onRegionChange(true).then(updateLocationString));
    selProvince.addEventListener('change', ()=>onProvinceChange(true).then(updateLocationString));
    selCityMun.addEventListener('change', ()=>onCityMunChange(true).then(updateLocationString));
    selBarangay.addEventListener('change', updateLocationString);

    /* ---------- PROFESSION CATEGORIES ---------- */
    const selProfCat = document.getElementById('selProfCat');
    const selProfRole = document.getElementById('selProfRole');
    const profCustomWrap = document.getElementById('profCustomWrap');
    const inputProfession = document.getElementById('profession');

    const PROF_MAP = {
      "Healthcare": ["Doctor","Nurse","Midwife","Pharmacist","Dentist","Medical Technologist","Caregiver","Therapist","Paramedic","Public Health Worker","Other (Custom)"],
      "Education": ["Teacher","Professor","Tutor","School Administrator","Guidance Counselor","Librarian","Other (Custom)"],
      "Engineering": ["Civil Engineer","Mechanical Engineer","Electrical Engineer","Electronics Engineer","Software Engineer","QA Engineer","Architect","Other (Custom)"],
      "IT & Digital": ["Developer","UI/UX Designer","Product Manager","Data Analyst","IT Support","Cybersecurity","Digital Marketer","Other (Custom)"],
      "Public Service": ["Gov‚Äôt Employee","Barangay Health Worker","Social Worker","Police","Firefighter","Military","Other (Custom)"],
      "Business": ["Entrepreneur","Operations","Sales","Finance/Accounting","HR","Admin Assistant","Other (Custom)"],
      "Student": ["Senior High Student","College Student","Graduate Student","Other (Custom)"],
      "Freelance & Creative": ["Freelancer","Photographer","Videographer","Writer","Artist","Musician","Other (Custom)"],
      "Skilled Trades": ["Driver","Electrician","Plumber","Mechanic","Construction Worker","Farmer","Fisherfolk","Other (Custom)"]
    };

    function fillProfCategories(){
      selProfCat.innerHTML = "";
      selProfCat.append(opt("Select Category‚Ä¶",""));
      Object.keys(PROF_MAP).sort().forEach(cat=>{
        selProfCat.append(opt(cat, cat));
      });
    }

    function fillProfRoles(cat){
      selProfRole.innerHTML = "";
      selProfRole.append(opt("Select Role‚Ä¶",""));
      (PROF_MAP[cat] || []).forEach(role=>{
        selProfRole.append(opt(role, role));
      });
    }

    function showCustom(show){
      profCustomWrap.style.display = show ? "" : "none";
      inputProfession.disabled = !show;
      if (show && !inputProfession.value) inputProfession.value = "";
    }

    selProfCat.addEventListener('change', ()=>{
      const cat = selProfCat.value;
      fillProfRoles(cat);
      selProfRole.disabled = !cat;
      selProfRole.value = "";
      showCustom(false);
    });

    selProfRole.addEventListener('change', ()=>{
      const isCustom = selProfRole.value === "Other (Custom)";
      showCustom(isCustom);
      if (!isCustom) {
        inputProfession.value = selProfRole.value ? `${selProfRole.value}` : "";
      }
    });

    function getProfessionForSave(){
      const cat = selProfCat.value;
      const role = selProfRole.value;
      if (role && role !== "Other (Custom)") return `${role} ‚Äî ${cat}`;
      const custom = inputProfession.value.trim();
      if (custom && cat) return `${custom} ‚Äî ${cat}`;
      return custom || "";
    }

    function initProfessionUI(savedProfession){
      fillProfCategories();
      selProfRole.disabled = true;
      inputProfession.disabled = true;

      if (!savedProfession) return;
      const parts = savedProfession.split("‚Äî").map(s=>s.trim());
      if (parts.length === 2){
        const [role, cat] = parts;
        const catOpt = Array.from(selProfCat.options).find(o=>o.value===cat);
        if (catOpt){
          selProfCat.value = cat;
          fillProfRoles(cat);
          selProfRole.disabled = false;
          const roleOpt = Array.from(selProfRole.options).find(o=>o.value===role);
          if (roleOpt){
            selProfRole.value = role;
            showCustom(false);
            inputProfession.value = role;
            return;
          }else{
            selProfRole.value = "Other (Custom)";
            showCustom(true);
            inputProfession.value = role;
            return;
          }
        }
      }
      selProfCat.value = "";
      selProfRole.innerHTML = '<option value="">Select Role‚Ä¶</option>';
      selProfRole.disabled = true;
      showCustom(true);
      inputProfession.value = savedProfession;
    }

    /* ---------- Edit/Save (upper-right) ---------- */
    function setupInlineEdit(uid){
      const editBtn = $("#editProfileBtn");
      const saveBtn = $("#saveProfileBtn");
      const profilePic = $("#profilePic");
      const inputs = ["name","email","phone","bio"].map(id=>document.getElementById(id)).filter(Boolean);

      editBtn?.addEventListener("click", ()=>{
        inputs.forEach(i=> i.removeAttribute("disabled"));
        ["selProfCat","selProfRole","profession","selRegion","selProvince","selCityMun","selBarangay"].forEach(id=>{
          const el=document.getElementById(id); if(el){ el.disabled=false; }
        });
        editBtn.classList.add('hidden');
        saveBtn.classList.remove('hidden');
      });

      saveBtn?.addEventListener("click", async ()=>{
        const updatedProfession = getProfessionForSave();
        const updatedData = {
          name: $("#name")?.value.trim() || "",
          email: $("#email")?.value.trim() || "",
          phone: $("#phone")?.value.trim() || "",
          profession: updatedProfession,
          location: $("#location")?.value.trim() || "",
          bio: $("#bio")?.value.trim() || "",
          photoURL: profilePic?.src || ""
        };
        try{
          await setDoc(doc(db,"users",uid), updatedData, { merge:true });
          if (auth.currentUser) await updateProfile(auth.currentUser, { photoURL: updatedData.photoURL });
          inputs.forEach(i=> i.setAttribute("disabled","true"));
          ["selProfCat","selProfRole","profession","selRegion","selProvince","selCityMun","selBarangay"].forEach(id=>{
            const el=document.getElementById(id); if(el){ el.disabled=true; }
          });
          document.getElementById("professionLine").textContent = updatedProfession || "Add your profession";
          alert("‚úÖ Profile updated successfully!");
        }catch(e){
          console.error(e); alert("Failed to update profile.");
        }
      });
    }

    /* ---------- Header summary updater (NEW) ---------- */
    function updateHeaderSummary(uid, userData){
      const ratingDisp = document.getElementById('ratingDisplay');
      const sinceDisp  = document.getElementById('sinceDisplay');
      const donsDisp   = document.getElementById('donationsDisplay');

      const ds = getArr(uid,'donations');
      const donationsCount = Array.isArray(ds) ? ds.length : (userData?.donations ?? 0);

      if (ratingDisp) ratingDisp.textContent = `(${userData?.rating ?? 0})`;
      if (sinceDisp)  sinceDisp.textContent  = `${userData?.since ?? ''}`;
      if (donsDisp)   donsDisp.textContent   = String(donationsCount);
    }

    /* NEW: reconcile local lists with Firestore */
    function reconcileLocalData(uid, userData){
      let ds = getArr(uid, 'donations');
      let rs = getArr(uid, 'requests');
      if (!Array.isArray(ds)) { ds = []; setArr(uid,'donations', ds); }
      if (!Array.isArray(rs)) { rs = []; setArr(uid,'requests', rs); }
      if ((userData.donations ?? 0) === 0 && ds.length > 0) setArr(uid,'donations', []);
      if ((userData.requests ?? 0) === 0 && rs.length > 0) setArr(uid,'requests', []);
    }

    /* ---------- Auth ---------- */
    onAuthStateChanged(auth, async (user)=>{
      if (!user) { location.href = "login.html"; return; }
      try{
        const snap = await getDoc(doc(db,"users",user.uid));
        const data = snap.exists() ? snap.data() : {};
        const userData = {
          uid: user.uid,
          name: data.name || user.displayName || "Anonymous User",
          email: data.email || "",
          phone: data.phone || "",
          profession: data.profession || "Add your profession",
          location: data.location || "",
          bio: data.bio || "",
          photoURL: data.photoURL || user.photoURL || "default-profile.png",
          donations: typeof data.donations === "number" ? data.donations : 0,
          requests: typeof data.requests === "number" ? data.requests : 0,
          rating: data.rating ?? 4.8,
          since: data.since || "2023",
          showLocation: data.showLocation ?? false,
          publicProfile: data.publicProfile ?? false,
        };
        localStorage.setItem("userProfile", JSON.stringify(userData));
        populateProfile(userData);

        /* NEW: clear stale local data if Firestore shows 0 */
        reconcileLocalData(user.uid, userData);

        renderLists(user.uid);       /* will call updateHeaderSummary */
        setupInlineEdit(user.uid);
        setupToggles(user.uid);
        setupAddButtons(user.uid, userData);
        setupDeleteHandlers(user.uid, userData);

        initProfessionUI(userData.profession === "Add your profession" ? "" : userData.profession);
        await initPSGCCascader(userData.location || "");
        applyToggleState('toggleLocation', userData.showLocation);
        applyToggleState('toggleProfile',  userData.publicProfile);

        /* Ensure header summary shows correct initial values */
        updateHeaderSummary(user.uid, userData);
      }catch(err){
        console.error("‚ùå Error loading user doc:", err);
        alert("Failed to load profile data ‚Äî see console.");
      }
    });

    /* Keep ‚Äúbio‚Äù label synced ‚Üí ‚ÄúHealth Professional‚Äù (unchanged behavior) */
    (() => {
      const bioLabel = document.querySelector('label[for="bio"]');
      if (bioLabel) bioLabel.textContent = 'Health Professional';
      const bioTA = document.getElementById('bio');
      const bioParagraph = document.querySelector('.bio');
      const syncBio = (val) => { if (bioParagraph) bioParagraph.textContent = (val ?? '').toString().trim(); };
      try { const cached = JSON.parse(localStorage.getItem('userProfile') || '{}'); if (typeof cached.bio === 'string') syncBio(cached.bio); } catch {}
      document.addEventListener('dmx:profileLoaded', (e) => { if (typeof e.detail?.bio === 'string') syncBio(e.detail.bio); });
      bioTA?.addEventListener('input', () => syncBio(bioTA.value));
      document.getElementById('saveProfileBtn')?.addEventListener('click', () => bioTA && syncBio(bioTA.value));
    })();
  </script>
</body>
</html>
