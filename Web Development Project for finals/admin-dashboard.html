<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DonorMedix · Admin Dashboard</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --brand:#3472a1;
      --brand-2:#0b90ab;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --bg:#f8fafc;
      --card:#ffffff;
      --shadow:0 8px 22px rgba(2,6,23,.06);
      --radius:14px;
      --danger:#ef4444;
      --warning:#f59e0b;
      --info:#3b82f6;
      --success:#22c55e;
    }

    body {
      min-height: 100vh;
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
      background: radial-gradient(circle at top left, #ecfeff 0, #f8fafc 45%, #e2fbe8 100%);
      color: var(--ink);
      transition: background .15s ease, color .15s ease;
    }

    .app { display: flex; min-height: 100vh; }

    .sidebar { width: 230px; background: linear-gradient(160deg, #020617, #0b1120, #1e293b); color:#e2e8f0; padding:20px 18px; display:flex; flex-direction:column; gap:24px; box-shadow:8px 0 24px rgba(15,23,42,.4); }
    .sidebar-brand { display:flex; align-items:center; gap:10px; }
    .sidebar-mark { width:34px;height:34px;border-radius:999px; background:conic-gradient(from 140deg, var(--brand), var(--brand-2)); display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;color:#ecfdf5;box-shadow:0 10px 25px rgba(37,99,235,.5); }
    .sidebar-title{font-size:15px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;}
    .sidebar-sub{font-size:11px;color:#9ca3af;text-transform:uppercase;letter-spacing:.12em;}
    .nav { display:flex; flex-direction:column; gap:4px; }
    .nav-link { display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; font-size:13px; color:#e5e7eb; text-decoration:none; border:1px solid transparent; opacity:.85; cursor:pointer; transition: background .1s ease, border-color .1s ease, transform .06s ease; }
    .nav-link span.icon { font-size:14px; width:18px; min-width:18px; text-align:center; display:inline-flex; align-items:center; justify-content:center; }
    .nav-link.active { background:linear-gradient(135deg, var(--brand), var(--brand-2)); color:#ecfdf5; border-color: rgba(129,140,248,.2); box-shadow:0 10px 25px rgba(15,23,42,.6); opacity:1; }

    .main{ flex:1; padding:20px 16px 32px; }
    .shell { max-width:1120px; margin:0 auto; }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:24px; }
    .brand{ display:flex; align-items:center; gap:10px; }
    .brand-mark{ width:32px; height:32px; border-radius:999px; background:conic-gradient(from 140deg, var(--brand), var(--brand-2)); display:flex; align-items:center; justify-content:center; color:#ecfdf5; font-weight:700; font-size:14px; box-shadow:0 8px 18px rgba(45,73,164,.436); }
    .btn{ border-radius:999px; padding:6px 14px; background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:#ecfdf5; border:none; cursor:pointer; display:inline-flex; gap:6px; }

    .card { background:var(--card); border-radius:var(--radius); border:1px solid rgba(148,163,184,.3); box-shadow:var(--shadow); padding:16px 18px; margin-bottom:18px; }
    .card-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; gap:8px; }
    .card-title{ font-size:15px; font-weight:600; color:var(--ink); }
    .card-subtitle{ font-size:12px; color:var(--muted); }
    .card-tag{ font-size:10px; padding:4px 9px; border-radius:999px; border:1px solid rgba(148,163,184,.55); text-transform:uppercase; color:var(--muted); background:rgba(248,250,252,.7); }

    .metric-tiles { display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-bottom:18px; }
    .metric-tile{ padding:18px; border-radius:12px; color:white; cursor:pointer; display:flex; flex-direction:column; gap:8px; box-shadow:0 8px 18px rgba(2,6,23,.08); transition:transform .08s ease; }
    .metric-tile:hover{ transform: translateY(-4px); box-shadow:0 14px 30px rgba(2,6,23,.12); }
    .metric-tile .label{ font-size:14px; font-weight:600; display:flex; align-items:center; gap:8px; }
    .metric-tile .value{ font-size:38px; font-weight:800; line-height:1; }
    .metric-tile .more{ font-size:13px; opacity:.95; display:flex; align-items:center; gap:8px; }

    .tile-blue{ background:linear-gradient(135deg,#0ea5e9,#0369a1); }
    .tile-green{ background:linear-gradient(135deg,#16a34a,#0f7a3a); }
    .tile-yellow{ background:linear-gradient(135deg,#f59e0b,#d97706); }
    .tile-red{ background:linear-gradient(135deg,#ef4444,#b91c1c); }

    /* layout for charts area */
    .charts-row { display:flex; gap:14px; margin-top:18px; margin-bottom:18px; }
    .chart-card { flex:1; min-height:300px; padding:12px; border-radius:12px; background:var(--card); border:1px solid rgba(148,163,184,.18); box-shadow:var(--shadow); display:flex; flex-direction:column; }
    .chart-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .chart-canvas-wrap { flex:1; display:flex; align-items:center; justify-content:center; padding:10px; }

    @media (max-width:1200px) { .metric-tiles{ grid-template-columns:repeat(2,1fr);} .charts-row { flex-direction:column; } }
    @media (max-width:520px) { .metric-tiles{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sidebar-brand">
        <div class="sidebar-mark">DM</div>
        <div>
          <div class="sidebar-title">DonorMedix</div>
          <div class="sidebar-sub">Admin Panel</div>
        </div>
      </div>

      <nav class="nav">
        <a href="admin-dashboard.html" class="nav-link active"><span class="icon"><i class="fa-solid fa-gauge"></i></span> Dashboard</a>
        <a href="admin-users.html" class="nav-link"><span class="icon"><i class="fa-solid fa-users"></i></span> User Management</a>
        <a href="admin-requests.html" class="nav-link"><span class="icon"><i class="fa-solid fa-list-check"></i></span> Requests</a>
        <a href="admin-donations.html" class="nav-link"><span class="icon"><i class="fa-solid fa-hand-holding-heart"></i></span> Donations</a>
        <a href="admin-settings.html" class="nav-link"><span class="icon"><i class="fa-solid fa-gear"></i></span> Settings</a>
      </nav>

      <div style="margin-top:auto">
        <a href="home.html" class="nav-link home-link"><span class="icon"><i class="fa-solid fa-house"></i></span> Home</a>
      </div>
    </aside>

    <main class="main">

        <!-- BIG FOUR METRIC TILES -->
        <div class="metric-tiles">
          <div class="metric-tile tile-blue" id="tileDonations" title="View donations">
            <div class="label"><i class="fa-solid fa-hand-holding-heart"></i> Donations</div>
            <div class="value" id="tileDonationsValue">0</div>
            <div class="more">More info <i class="fa-solid fa-arrow-right"></i></div>
          </div>

          <div class="metric-tile tile-green" id="tileRequests" title="View requests">
            <div class="label"><i class="fa-solid fa-list-check"></i> Requests</div>
            <div class="value" id="tileRequestsValue">0</div>
            <div class="more">More info <i class="fa-solid fa-arrow-right"></i></div>
          </div>

          <div class="metric-tile tile-yellow" id="tileUsers" title="View users">
            <div class="label"><i class="fa-solid fa-users"></i> Users</div>
            <div class="value" id="tileUsersValue">0</div>
            <div class="more">More info <i class="fa-solid fa-arrow-right"></i></div>
          </div>

          <div class="metric-tile tile-red" id="tileFulfilled" title="View fulfilled requests">
            <div class="label"><i class="fa-solid fa-check-double"></i> Fulfilled Requests</div>
            <div class="value" id="tileFulfilledValue">0</div>
            <div class="more">More info <i class="fa-solid fa-arrow-right"></i></div>
          </div>
        </div>

        <!-- CHARTS: placed BELOW the metric tiles -->
        <div class="charts-row">
          <div class="chart-card">
            <div class="chart-header">
              <div style="font-weight:600">Doughnut Chart — Most donated medicines</div>
              <div style="font-size:12px;color:var(--muted)">Realtime · donations</div>
            </div>
            <div class="chart-canvas-wrap">
              <canvas id="doughnutChart" style="max-width:100%; max-height:320px;"></canvas>
            </div>
          </div>

          <div class="chart-card">
            <div class="chart-header">
              <div style="font-weight:600">Bar Chart — Monthly activity</div>
              <div style="font-size:12px;color:var(--muted)">Realtime · donations / requests / users</div>
            </div>
            <div class="chart-canvas-wrap">
              <canvas id="barChart" style="width:100%; height:320px"></canvas>
            </div>
          </div>
        </div>

        <!-- small summary card (optional, keep or remove) -->
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Dashboard Overview</div>
              <div class="card-subtitle">High–level stats computed from Firestore collections.</div>
            </div>
            <span class="card-tag">Dashboard</span>
          </div>
          <div style="border-top: 1px solid var(--line); margin: 16px 0;"></div>
          <div style="font-size:13px;color:var(--muted)">Recent Activity will appear here (bind to a logs collection if you have one).</div>
        </section>

      </div>
    </main>
  </div>

<script type="module">
/* ====== Real-time admin dashboard wiring (drop-in replacement) ======
   - Initializes app safely, guards for admin role using users/{uid}.role == 'admin'
   - Attaches live listeners and updates tiles + charts
   Paste this block into admin-dashboard.html replacing earlier module script.
===================================================================== */

import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import {
  getFirestore, collection, doc, getDoc, onSnapshot, query, orderBy
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

// --- Firebase config (keep same values) ---
const firebaseConfig = {
  apiKey: "AIzaSyAaWN2gj3VJxT6kwOvCX4LIXkWlbt0LTHQ",
  authDomain: "donormedix.firebaseapp.com",
  projectId: "donormedix",
  storageBucket: "donormedix.appspot.com",
  messagingSenderId: "627472172279",
  appId: "1:627472172279:web:9bf645b54d33075a0d7ff2",
  measurementId: "G-NTNPR4FPT7"
};

// init app (reuse if already initialized)
const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// DOM refs
const tileDonationsVal = document.getElementById('tileDonationsValue');
const tileRequestsVal  = document.getElementById('tileRequestsValue');
const tileUsersVal     = document.getElementById('tileUsersValue');
const tileFulfilledVal = document.getElementById('tileFulfilledValue');

const doughnutCanvas = document.getElementById('doughnutChart');
const barCanvas = document.getElementById('barChart');

// Ensure canvases exist
if (!doughnutCanvas || !barCanvas) {
  console.warn('Charts canvases not found. Ensure #doughnutChart and #barChart are present in DOM.');
}

// NOTICE area
const NOTICE_ID = 'adminNotice';
(function ensureNotice() {
  if (document.getElementById(NOTICE_ID)) return;
  const shell = document.querySelector('.shell') || document.body;
  const div = document.createElement('div');
  div.id = NOTICE_ID;
  div.style.margin = '8px 0';
  shell.insertBefore(div, shell.firstChild);
})();
function showNotice(msg, isError = false) {
  const el = document.getElementById(NOTICE_ID);
  if (!el) return;
  el.innerHTML = msg;
  el.style.padding = '10px';
  el.style.borderRadius = '8px';
  el.style.fontSize = '13px';
  el.style.background = isError ? '#fee2e2' : '#ecfdf5';
  el.style.border = isError ? '1px solid #fecaca' : '1px solid #bbf7d0';
  el.style.color = isError ? '#7f1d1d' : '#065f46';
}
function clearNotice(){ const el=document.getElementById(NOTICE_ID); if(el) el.innerHTML=''; }

// Utility: parse Firestore timestamps / strings / numbers to Date
function parseToDate(value) {
  if (!value) return null;
  if (typeof value.toDate === 'function') {
    try { return value.toDate(); } catch (e) { /* fallthrough */ }
  }
  if (value && typeof value === 'object' && value._seconds) {
    return new Date(value._seconds * 1000);
  }
  if (typeof value === 'string') {
    const d = new Date(value);
    if (!isNaN(d)) return d;
  }
  if (typeof value === 'number') {
    if (value > 1e12) return new Date(value);
    return new Date(value * 1000);
  }
  return null;
}

// Utility: extract numeric quantity from a doc (candidates)
function extractQuantity(data = {}) {
  const candidates = ['quantity','qty','amount','count','total'];
  for (const k of candidates) {
    if (data[k] !== undefined && data[k] !== null) {
      const v = data[k];
      if (typeof v === 'number' && !Number.isNaN(v)) return v;
      if (typeof v === 'string') {
        const p = parseFloat(String(v).replace(/[, ]+/g,''));
        if (!isNaN(p)) return p;
      }
    }
  }
  // fallback to 1 when no numeric field provided
  return 1;
}

// Chart.js instances (if canvases exist)
let donutChart = null;
let barChart = null;
if (doughnutCanvas) {
  donutChart = new Chart(doughnutCanvas.getContext('2d'), {
    type: 'doughnut',
    data: { labels: ['Loading'], datasets: [{ data: [1], backgroundColor: ['#f97316'] }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
  });
}
if (barCanvas) {
  barChart = new Chart(barCanvas.getContext('2d'), {
    type: 'bar',
    data: { labels: [], datasets: [
      { label: 'Donations (qty sum)', data: [], backgroundColor: '#f97316' },
      { label: 'Requests (qty sum)', data: [], backgroundColor: '#16a34a' },
      { label: 'New Users (count)', data: [], backgroundColor: '#06b6d4' }
    ] },
    options: {
      responsive: true, maintainAspectRatio: false,
      scales: { x: { stacked: false }, y: { beginAtZero: true } },
      plugins: { legend: { position: 'top' } }
    }
  });
}

// Caches used for aggregation
let donationsCache = []; // array of {id, data}
let requestsCache = [];
let usersCache = [];

// Helpers for monthly keys/labels
function lastNMonthKeys(n = 7) {
  const arr = [];
  const now = new Date();
  for (let i = n - 1; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    arr.push(`${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}`);
  }
  return arr;
}
function getLastNMonthsLabels(n = 7) {
  const res = [];
  const now = new Date();
  for (let i = n - 1; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    res.push(d.toLocaleString(undefined, { month: 'short', year: 'numeric' }));
  }
  return res;
}
function monthKeyFromDate(d) {
  if (!d) return null;
  return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}`;
}

// Chart + tile update functions (use caches)
function updateTilesFromCache() {
  // donations total quantity
  const totalDonQty = donationsCache.reduce((s, it) => s + extractQuantity(it.data || {}), 0);
  tileDonationsVal && (tileDonationsVal.textContent = totalDonQty);

  // requests total quantity
  const totalReqQty = requestsCache.reduce((s, it) => s + extractQuantity(it.data || {}), 0);
  tileRequestsVal && (tileRequestsVal.textContent = totalReqQty);

  // users count
  tileUsersVal && (tileUsersVal.textContent = usersCache.length);

  // fulfilled requests count
  const fulfilled = requestsCache.reduce((acc, it) => {
    const s = ((it.data && (it.data.status || it.data.state)) || '').toString().toLowerCase();
    return acc + ((s === 'fulfilled' || s === 'done' || s === 'completed') ? 1 : 0);
  }, 0);
  tileFulfilledVal && (tileFulfilledVal.textContent = fulfilled);
}

function updateDoughnutFromCache() {
  if (!donutChart) return;
  const counts = {}; // medicine -> qty sum
  donationsCache.forEach(it => {
    const d = it.data || {};
    const med = (d.medicineName || d.medicine || d.medicine_name || 'Unknown').toString().trim() || 'Unknown';
    counts[med] = (counts[med] || 0) + extractQuantity(d);
  });
  const entries = Object.entries(counts).sort((a,b)=> b[1]-a[1]);
  const top = entries.slice(0,6);
  const others = entries.slice(6);
  const labels = top.map(e => e[0]);
  const data = top.map(e => e[1]);
  if (others.length) {
    const otherSum = others.reduce((s,e)=> s + e[1], 0);
    labels.push('Other'); data.push(otherSum);
  }
  if (!labels.length) { labels.push('No donations'); data.push(1); }
  const palette = ['#f87171','#fb923c','#f59e0b','#f97316','#34d399','#60a5fa','#a78bfa','#f472b6'];
  donutChart.data = { labels, datasets: [{ data, backgroundColor: palette.slice(0, labels.length) }] };
  donutChart.update();
}

function updateBarFromCache(months = 7) {
  if (!barChart) return;
  const monthKeys = lastNMonthKeys(months);
  const labels = getLastNMonthsLabels(months);

  const donationsCounts = monthKeys.map(()=>0);
  const requestsCounts = monthKeys.map(()=>0);
  const usersCounts = monthKeys.map(()=>0);

  donationsCache.forEach(it => {
    const d = it.data || {};
    const dt = parseToDate(d.createdAt || d.created_at || d.timestamp);
    const key = monthKeyFromDate(dt);
    const idx = monthKeys.indexOf(key);
    if (idx >= 0) donationsCounts[idx] += extractQuantity(d);
  });

  requestsCache.forEach(it => {
    const d = it.data || {};
    const dt = parseToDate(d.createdAt || d.created_at || d.timestamp);
    const key = monthKeyFromDate(dt);
    const idx = monthKeys.indexOf(key);
    if (idx >= 0) requestsCounts[idx] += extractQuantity(d);
  });

  usersCache.forEach(it => {
    const d = it.data || {};
    const dt = parseToDate(d.createdAt || d.created_at || d.joined || d.created);
    const key = monthKeyFromDate(dt);
    const idx = monthKeys.indexOf(key);
    if (idx >= 0) usersCounts[idx] += 1;
  });

  barChart.data.labels = labels;
  barChart.data.datasets[0].data = donationsCounts;
  barChart.data.datasets[1].data = requestsCounts;
  barChart.data.datasets[2].data = usersCounts;
  barChart.update();
}

// Real-time snapshot attach — called only after admin verification
let unsubDonations = null;
let unsubRequests = null;
let unsubUsers = null;
function attachRealtimeListeners() {
  // detach previous if present
  try { unsubDonations && unsubDonations(); } catch(e){}
  try { unsubRequests && unsubRequests(); } catch(e){}
  try { unsubUsers && unsubUsers(); } catch(e){}

  // donations
  try {
    unsubDonations = onSnapshot(collection(db, 'donations'), snap => {
      donationsCache = [];
      snap.forEach(d => {
        const data = d.data ? d.data() : d;
        donationsCache.push({ id: d.id || data.id || null, data });
      });
      updateTilesFromCache();
      updateDoughnutFromCache();
      updateBarFromCache(7);
    }, err => {
      console.error('donations onSnapshot error', err);
      showNotice('Permission denied reading donations. Ensure you are signed in as admin and rules allow access.', true);
    });
  } catch (err) {
    console.error('attach donations error', err);
  }

  // requests
  try {
    unsubRequests = onSnapshot(collection(db, 'requests'), snap => {
      requestsCache = [];
      snap.forEach(d => {
        const data = d.data ? d.data() : d;
        requestsCache.push({ id: d.id || data.id || null, data });
      });
      updateTilesFromCache();
      updateBarFromCache(7);
    }, err => {
      console.error('requests onSnapshot error', err);
      showNotice('Permission denied reading requests. Ensure you are signed in as admin and rules allow access.', true);
    });
  } catch (err) {
    console.error('attach requests error', err);
  }

  // users
  try {
    // Use a query sorted by createdAt desc (if field exists)
    const qUsers = query(collection(db, 'users'), orderBy('createdAt', 'desc'));
    unsubUsers = onSnapshot(qUsers, snap => {
      usersCache = [];
      snap.forEach(d => {
        const data = d.data ? d.data() : d;
        usersCache.push({ id: d.id || data.id || null, data });
      });
      updateTilesFromCache();
      updateBarFromCache(7);
    }, err => {
      console.error('users onSnapshot error', err);
      showNotice('Permission denied reading users. Ensure you are signed in as admin and rules allow access.', true);
    });
  } catch (err) {
    console.error('attach users error', err);
  }
}

// AUTH guard: wait for sign-in & verify users/{uid}.role === 'admin'
onAuthStateChanged(auth, async (user) => {
  // detach listeners on sign-out
  if (!user) {
    showNotice('Not signed in. Sign in as admin to view dashboard.', true);
    try { unsubDonations && unsubDonations(); } catch(e){}
    try { unsubRequests && unsubRequests(); } catch(e){}
    try { unsubUsers && unsubUsers(); } catch(e){}
    donationsCache = requestsCache = usersCache = [];
    updateTilesFromCache();
    return;
  }

  try {
    const profileRef = doc(db, 'users', user.uid);
    const profileSnap = await getDoc(profileRef);
    if (!profileSnap.exists()) {
      showNotice(`Admin profile document users/${user.uid} is missing. Set role:"admin" in that document.`, true);
      return;
    }
    const profile = profileSnap.data() || {};
    if (profile.role === 'admin') {
      clearNotice();
      attachRealtimeListeners();
    } else {
      showNotice('Access denied — your account is not an admin. Contact an administrator to set role:"admin".', true);
      try { unsubDonations && unsubDonations(); } catch(e){}
      try { unsubRequests && unsubRequests(); } catch(e){}
      try { unsubUsers && unsubUsers(); } catch(e){}
    }
  } catch (err) {
    console.error('Admin verification failed:', err);
    showNotice('Failed to verify admin role. See console for details.', true);
  }
});

// Tile clickable behavior (navigate to appropriate pages)
document.getElementById('tileDonations')?.addEventListener('click', () => window.location.href = 'admin-donations.html');
document.getElementById('tileRequests')?.addEventListener('click', () => window.location.href = 'admin-requests.html');
document.getElementById('tileUsers')?.addEventListener('click', () => window.location.href = 'admin-users.html');
document.getElementById('tileFulfilled')?.addEventListener('click', () => window.location.href = 'admin-requests.html?filter=fulfilled');

</script>


</body>
</html>
